#!/bin/bash

# master-file

# intance store mount.
istore_dev=/dev/sda2
istore_mnt=/mnt/istore
if [ ! -b $istore_dev ]; then
    echo "istore device $istore_dev isn't existed, skipped"
elif ! file -s $istore_dev | grep -q ext[34]; then
    echo "fstype of $istore_dev isn't ext3/4, skipped"
else
    echo "Config instance-store"

    echo "    Checking previous mount"
    read dev mnt _ < <(grep "$istore_dev" /etc/fstab)
    if [ "$dev" != "$istore_dev" ] || [ "$mnt" != /mnt ]; then
        echo "    Not an ec2-instance, or istore is already moved. "

    else
        echo "    Unmount $istore_mnt"
        umount $istore_dev

        if ! mkdir -p $istore_mnt; then
            echo "    Failed to create directory $istore_mnt"
            exit 1
        fi

        echo "    Config entry $istore_dev in /etc/fstab"
        if ! lineconf /etc/fstab $istore_dev \
                "$istore_dev $istore_mnt auto defaults 0 0"; then
            echo "        Failed"
            exit 1
        fi

        echo "    Mount $istore_mnt"
        mount $istore_mnt

        echo "    Initialize permission of $istore_mnt"
        install -d -m 2775 -o root -g dev $istore_mnt
    fi
fi

# ec2-cmd alt.
echo "Checking ec2-cmd overrides"
    f=/usr/bin/ec2-cmd
    if [ ! -f "$f" ]; then
        echo "    ec2-api-tools is required. "
        exit 1
    fi

    fdir="${f%/*}"

    if grep -q Amazon.com $f; then
        echo "    Override $f"
        cd "$fdir"
        mv -f $f $f-orig
    fi

    cp -f @setupdir@/ec2-cmd $f
