#!/bin/bash

if ! svn info >/dev/null 2>&1; then
	echo "Current directory isn't versioned. "
	exit 1
fi

for envf in ../../.env ../.env .env; do
    if [ -f $envf ]; then
        . $envf
    fi
done

for d in "$@"; do

    mkdir $d
    svn add $d

    cd $d

    autoinit
    vercomp -i minor

    cat <<EOT | tee post-install.sh.in pre-remove.sh.in post-remove.sh.in >/dev/null
#!/bin/sh

# master-file

EOT

    chmod a+x *.sh.in

    cat <<EOT >>Makefile.am

setup_SCRIPTS = \\
	post-install.sh \\
	pre-remove.sh \\
	post-remove.sh

EXTRA_DIST = post-install.sh.in pre-remove.sh.in post-remove.sh.in
CLEANFILES = post-install.sh    pre-remove.sh    post-remove.sh

post-install.sh: post-install.sh.in Makefile
	\$(do_subst) <\$(srcdir)/post-install.sh.in >\$@

pre-remove.sh: pre-remove.sh.in Makefile
	\$(do_subst) <\$(srcdir)/pre-remove.sh.in >\$@

post-remove.sh: post-remove.sh.in Makefile
	\$(do_subst) <\$(srcdir)/post-remove.sh.in >\$@
EOT

    autoreconf2 -i
    rm -fr autom4te.cache

    svn add *

    # -i indep binary.
    . dh_make-autover --createorig -i

	cd debian
		mv postinst.ex postinst
		mv prerm.ex    prerm
		mv postrm.ex   postrm

		line=`grepl "configure)" postinst`
		sedit postinst sh -c "head -$line; \
			echo \"        /usr/share/setup/$d/post-install.sh\"; \
			cat"

		line=`grepl "deconfigure)" prerm`
		sedit prerm sh -c "head -$line; \
			echo \"        /usr/share/setup/$d/pre-remove.sh\"; \
			cat"

		line=`grepl "disappear)" postrm`
		sedit postrm  sh -c "head -$line; \
			echo \"        /usr/share/setup/$d/post-remove.sh\"; \
			cat"

		chmod a+x postinst prerm postrm

		vi control
	cd ..

	svn add --depth empty debian
	svnpsl svn:ignore "$d" '*.log' '*.ex' '*.EX' '*.substvars' 'changelog' 'files' \; debian
	svn add debian/{control,postinst,prerm,postrm,docs,rules,copyright,compat,README.*}

    # makelook

	cd ..

	svn ci -m "Initial by sdu-creator" "$d"

done
