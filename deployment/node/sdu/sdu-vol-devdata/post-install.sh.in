#!/bin/bash

# master-file

# 0, id of this inst
if inst_id=`ec2-metadata -i`; then
    # "instance-id: xxx"
    inst_id=${inst_id#instance-id: }
else
    # not an instance.
    exit 1
fi

inst_name=`rsubstecho $inst_id`
inst_name="${inst_name%[*}"

mount_point=/mnt/devdata

# 1, attach
vol_old=
att_old=

vol_cur=`substecho vol:devdata`
att_cur=

while read dev mp fs opts x y; do
    if [ "$mp" = "$mount_point" ]; then
        echo "Current $mount_point is attached to $inst_name: $dev"
        att_old="$dev"
        break
    fi
done </etc/fstab

echo "Query the status of attachment $vol_cur"
while read type vol inst dev status t0; do
    if [ "$type" != ATTACHMENT ]; then continue; fi
    if [ "$vol" = $vol_cur ]; then
        if [ "$inst" = $inst_id ]; then
            echo "Already attached to this instance: $dev"
            att_cur="$dev"
            break
        elif [ "$status" = "attached" ]; then
            echo "Already attached to a different instance, try detach first"
            if ! ec2-detach-volume vol:devdata; then
                echo "Failed to detach, try with --force?"
                exit 1
            else
                att_cur=
            fi
        fi
        break
    elif [ -n "$att_old" ]; then
        if [ "$inst" = $inst_id ] && [ "$dev" = $att_old ]; then
            echo "Detach the old volume $vol"
            umount $att_old
            if ! ec2-detach-volume $vol; then
                echo "Failed to detach the old volume $vol, try with --force?"
                exit 1
            fi
            while ec2-describe-volumes $vol | grep -q detaching; do
                echo "Detaching..."
            done
            echo "Detached. "
        fi
    fi

done < <(NO_SUBST=1 ec2-describe-volumes)

if [ -z "$att_cur" ]; then

    if [ -z "$att_old" ]; then
        echo "Find next device name to attach"
        if ! att_cur=`nextdev /dev/sd fghijklmnop`; then
            echo "No more available /dev/sd? name"
            exit 1
        fi
    else
        att_cur=$att_old
    fi

    substecho "Attach vol:devdata to $att_cur"
    if ! ec2-attach-volume vol:devdata -i $inst_id -d $att_cur; then
        echo "Failed to attach. "
        exit 1
    fi

    while ec2-describe-volumes vol:devdata | grep -q attaching; do
        echo "Attaching..."
    done

    echo "Resize2fs to fill any expansion"
    resize2fs $att_cur
fi

# 2, mount
install -d -m 775 -o dev -g dev $mount_point

if lineconf -e /etc/fstab $mount_point \
        "$att_cur $mount_point ext3 defaults 0 0"; then
    echo "Updated entry in /etc/fstab. "

    echo "Unmount $att_cur"
    umount $att_cur
fi

echo "Mount $att_cur on $mount_point"
mount $mount_point

exit 0
