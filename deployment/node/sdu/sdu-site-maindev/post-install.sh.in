#!/bin/sh

# master-file

# 1, Checkout http://svn.secca-project.com/public/trunk/ to
#       PKGDATA/html
#    cuz devsite will always run on the main-dev, so we can safely checkout
#    from the local repository.
#
#    Instead of checkout from /repos/svn (which is provided by serv-seccasvn,
#    we will get from /mnt/devdata/svnrepo instead. )
#
#    Switch between either is easy cuz the UUID is always the same.

local_repo=/mnt/devdata/svnrepo
if [ -d $local_repo ]; then
    echo "Found vol:devdata/svnrepo, use it. "
    url=file://$local_repo/public/trunk/www
else
    echo "Not an main-dev instance, checkout site from svn remote"
    # url=http://svn.secca-project.com/public/trunk/www
    # url=svn://svn.secca-project.com:1030/public/trunk/www
    url=svn+ssh://svn.secca-project.com/public/trunk/www
fi

devsite_dir=@pkgdatadir@/html

    if [ -d $devsite_dir ]; then
        echo "Already checked out: $devsite_dir"
        svn up $devsite_dir
    else
        echo "Initialize $devsite_dir"
        if ! install -d -m 2775 -o root -g dev $devsite_dir; then
            echo "    failed"
            exit 1
        fi

        echo "Checkout $url to $devsite_dir"

        # IGNORE_EXTERNALS=--ignore-externals
        IGNORE_EXTERNALS=
        if ! svn-002 co $IGNORE_EXTERNALS $url $devsite_dir; then
            echo "checkout failed. "
            exit 1
        fi
    fi

echo "Config apache2"

    a2enmod  userdir
    a2ensite secca-devsite.site
    a2reload
