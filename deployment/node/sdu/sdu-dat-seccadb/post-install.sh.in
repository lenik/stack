#!/bin/bash

# master-file

dbdir=/mnt/devdata/seccadb

if [ -d $dbdir/base ]; then
	echo "seccadb cluster is existed, reuse it. "
else
    echo "Create seccadb cluster"

    install -d -opostgres -gdev $dbdir

    sudo -upostgres pg_createcluster \
        -d $dbdir \
        -e utf-8 \
        -p 1063 \
        --start \
        9.1 seccadb

    # shortcuts are generated by AM.
fi

hba=/etc/postgresql/9.1/seccadb/pg_hba.conf

lineconf -tm "Configure $hba" \
    $hba SDUC-1-192 \
    "host all all 192.168.0.0/16 md5"

echo "Set postgres default password"
    seccadb-psql -d template1 -c \
        "alter user postgres with password 'cW3EADp8'"

echo "Enable pl/langs for seccadb databases"
    seccadb-createlang plperl template1
    seccadb-createlang plpythonu template1

echo "Search installed databases"
    while read db; do
        eval "db_${db//[^a-zA-Z0-9]/_}=1"
    done < <(seccadb-psql -Atc 'select datname from pg_database')

if [ "$db_playdb" = 1 ]; then
    echo "  Play database is installed. "
else
    echo "Create play user and database"
        seccadb-createuser \
            --connection-limit=10 \
            --no-createdb \
            --no-createrole \
            --no-superuser \
            play

        seccadb-psql -d template1 -c \
            "alter user play with password 'yalp'"

        seccadb-createdb \
            --owner=play \
            "playdb" "For test purpose and play-around"
fi

if [ "$db_devdb" = 1 ]; then
    echo "  Dev database is installed. "
else
    echo "Create dev user and database"
        seccadb-createuser \
            --connection-limit=20 \
            --no-createdb \
            --createrole \
            --no-superuser \
            dev

        seccadb-psql -d template1 -c \
            "alter user dev with password 's3cret'"

        seccadb-createdb \
            --owner=dev \
            "devdb" "Used by dev-sites"
fi

if [ "$db_semsdb" = 1 ]; then
    echo "  SEMS database is installed. "
else
    echo "Create secca user and database"
        seccadb-createuser \
            --connection-limit=20 \
            --no-createdb \
            --createrole \
            --no-superuser \
            semsadmin

        seccadb-psql -d template1 -c \
            "alter user semsadmin with password 'MxDkUWl1'"

        seccadb-createdb \
            --owner=semsadmin \
            "semsdb" "Used by SEMS applications"
fi


configinc=/etc/phppgadmin/config.inc.php
    lineconf -tm "Add SECCA DB to phppgadmin: " -p '<?php # ' -s ' ?>' \
        $configinc @server::seccadb \
        "<?php add_server('SECCA DB', 'localhost', 1063); ?>"

exit 0
