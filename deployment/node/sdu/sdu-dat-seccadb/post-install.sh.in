#!/bin/bash

# master-file

if [ ! -d /node/data/seccadb/base ]; then
    echo "Create seccadb cluster"

    install -d -opostgres -gdev /node/data/seccadb

    sudo -upostgres pg_createcluster \
        -d /node/data/seccadb \
        -e utf-8 \
        -p 1063 \
        --start \
        8.4 seccadb

    # shortcuts are generated by AM.
fi

hba=/etc/postgresql/8.4/seccadb/pg_hba.conf

echo "Configure $hba"
    lineconf -t SDUC-1-192 \
        "host all all 192.168.0.0/16 md5" $hba

echo "Set postgres default password"
    seccadb-psql -d template1 -c \
        "alter user postgres with password 'cW3EADp8'"

echo "Search installed databases"
    while read db; do
        eval "db_$db=1"
    done < <(seccadb-psql -Atc 'select datname from pg_database')

if [ "$db_playdb" = 1 ]; then
    echo "  Play database is installed. "
else
    echo "Create play user and database"
        seccadb-createuser \
            --connection-limit=10 \
            --no-createdb \
            --no-createrole \
            --no-superuser \
            play

        seccadb-psql -d template1 -c \
            "alter user play with password 'yalp'"

        seccadb-createdb \
            --owner=play \
            "playdb" "For test purpose and play-around"
fi

if [ "$db_devdb" = 1 ]; then
    echo "  Dev database is installed. "
else
    echo "Create dev user and database"
        seccadb-createuser \
            --connection-limit=20 \
            --no-createdb \
            --createrole \
            --no-superuser \
            dev

        seccadb-psql -d template1 -c \
            "alter user dev with password 's3cret'"

        seccadb-createdb \
            --owner=dev \
            "devdb" "Used by dev-sites"
fi
