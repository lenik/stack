#!/bin/bash
# master-file

java_prefix="@DESTDIR@/opt/java"
install -d -m 755 -o root -g dev $java_prefix
cd "$java_prefix"

# Find the latest installed version
installed=
for d in "$java_prefix/jdk"?.?.*/; do
    d="${d%/}"
    if [ ! -f "$d/lib/tools.jar" ]; then continue; fi
    echo "Installed JDK: $d"
    installed="$d"
done

if [ -n "$installed" ]; then
    echo "Found installed JDK: $installed"
    instdir="$installed"
    javahome="${installed##*/}"

else

    echo "Search latest linux JDK6 bin file..."
        index=http://download.java.net/jdk6/latest_binaries/
        latest_file=`wget -qO- $index | grep lin32JDKbin | grep -o -m1 'jdk-.*.bin' `
        if [ -z "$latest_file" ]; then
            echo "Not found. "
            exit 1
        fi

    url=`urljoin "$index" "$latest_file"`
    echo "Download $url..."
        if ! file=`wgetc -m755 "$url"`; then
            echo "Failed to download. "
        fi

    javahome=`grep -a -m1 javahome= $file`
    javahome=${javahome#*=}
    instdir="$java_prefix/$javahome"

    echo "Install $file to $instdir..."
    "$file"
fi

echo "Link jdk-6 to $javahome"
    ln -snf $javahome jdk-6

echo "$instdir" >"@DESTDIR@@pkgdatadir@/instdir"

echo "Set preferred alternatives for Sun JDK-6"
    for f in $instdir/bin/*; do
        if [ -x "$f" ]; then
            base=${f##*/}
            update-alternatives --install /usr/bin/$base $base "$f" 3000
        fi
    done
    for f in $instdir/jre/bin/*; do
        if [ -x "$f" ]; then
            base=${f##*/}
            update-alternatives --install /usr/bin/$base $base "$f" 5000
        fi
    done
