<ui:composition template="/template/custom-rich.xhtml" xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:p="http://primefaces.org/ui" xmlns:t="http://myfaces.apache.org/tomahawk" xmlns:icsf="http://java.sun.com/jsf/composite/3/7"
    xmlns:sem="http://java.sun.com/jsf/composite/3/15" xmlns:fr="http://java.sun.com/jsf/composite/frame">

    <ui:param name="bean" value="${issueAdminBean}" />
    <ui:param name="obj" value="${bean.openedObject}" />

    <ui:define name="content">
        <h:form id="issueMainForm">
            <t:div style="width:100%; background-color:#FFFFFF;">
                <t:div styleClass="north layout" style="height:50px;">
                    <t:div id="layout-header">
                        <h:outputText value="问题" rendered="${bean.editing ==  0}" />
                        <span class="issue-id">
                            <h:outputText value="${obj.id}" rendered="${bean.editing == 0}" />
                        </span>
                        <h:outputText value="：" rendered="${bean.editing == 0}" />
                        <h:outputText value="${obj.label}" rendered="${bean.editing == 0}" />
                        <h:outputText value="标题:" rendered="${bean.editing != 0}" />
                        <p:inputText value="${obj.label}" rendered="${bean.editing != 0}" />
                    </t:div>
                </t:div>

                <t:div style="border:1px solid #A6C9E2; border-radius:5px;width:100%; height:400px;">
                    <table class="center">
                        <tr>
                            <td class="layout" valign="top" align="center">
                                <t:div id="layout-west">
                                    <t:div id="issue-attention-container" rendered="${bean.editing == 0}">
                                        <div align="center">
                                            <p:commandLink styleClass="favoritestar" title="添加到我的关注"
                                                style="#{bean.fav == true? 'background-position:0 -40px;' : 'background-position:0 0;'}"
                                                update=":issueMainForm:issue-favoritecount" actionListener="#{bean.attention(bean.fav)}">
                                            </p:commandLink>
                                        </div>
                                        <t:div id="issue-favoritecount" styleClass="issue-favoritecount-container">
                                            <h:outputText class="favoritecount" value="${bean.favNum}" />
                                        </t:div>
                                    </t:div>
                                </t:div>
                            </td>
                            <td class="layout middle" valign="top">
                                <p:editor value="${obj.text}" width="640" />
                                <p:separator />
                                <t:div>
                                    <h:outputText value="相关机会" />
                                    <h:outputText value="相关订单" />
                                </t:div>
                                <p:separator />
                                <t:div id="issue-process">
                                    <h:outputText value="状态：" />
                                    <h:outputText id="issueState" value="${obj.stateName}" />
                                    <h:outputText value="|" />
                                    <h:outputText value="所有者：" />
                                    <h:outputText value="${obj.owner.displayName}" />
                                    <p:commandLink value="编辑" rendered="${bean.operatable and (bean.editing != -1)}"
                                        actionListener="${bean.startEditing}"
                                        update=":issueMainForm:reply-container, :issueMainForm:layout-header, :issueMainForm:layout-west, :issueMainForm:layout-east, :issueMainForm:issue-process" />
                                    <p:commandLink value="保存" rendered="${bean.editing != 0}"
                                        actionListener="${bean.doSaveIssue}"
                                        update=":issueMainForm:reply-container, :issueMainForm:layout-header, :issueMainForm:layout-west, :issueMainForm:layout-east, :issueMainForm:issue-observers, :issueMainForm:issue-process" />
                                    <p:commandLink value="取消" rendered="${bean.editing == 1}"
                                        actionListener="${bean.cancelEditing}"
                                        update=":issueMainForm:reply-container, :issueMainForm:layout-header, :issueMainForm:layout-west, :issueMainForm:layout-east, :issueMainForm:issue-observers, :issueMainForm:issue-process" />
                                </t:div>
                            </td>
                            <td class="layout" valign="top">
                                <t:div id="issue-observers" style="width:200px;">
                                    <p:dataTable value="#{obj.observers}" var="observer" type="none">
                                        <p:column headerText="负责">
                                            <h:outputText value="#{observer.user.displayName}" />
                                        </p:column>
                                        <p:column headerText="权限">
                                            <p:selectBooleanCheckbox disabled="true"
                                                value="${observer.manager}" />
                                        </p:column>
                                        <p:column>
                                            <p:commandLink value="del" actionListener="${bean.deselectObserver(observer)}"
                                                rendered="${bean.operatable and (bean.editing != 0)}" update=":issueMainForm:issue-observers">
                                            </p:commandLink>
                                        </p:column>
                                    </p:dataTable>
                                </t:div>
                            </td>
                            <td class="layout">
                                <t:div id="layout-east">
                                    <t:div rendered="#{bean.editing != 0}">
                                        <p:dataList value="#{bean.availableObservers}" id="available-observers"
                                            paginator="true" effectSpeed="fast" var="observer" type="none" rows="5"
                                            paginatorTemplate="{PreviousPageLink} {CurrentPageReport} {NextPageLink} {RowsPerPageDropdown}"
                                            rowsPerPageTemplate="5,10,15">
                                            <p:column>
                                                <h:outputText value="#{observer.user.displayName}" />
                                                <p:commandButton icon="ui-icon-tag" update=":issueMainForm:observercontent"
                                                    oncomplete="testDialog.show()" disabled="#{observer.selected}">
                                                    <f:setPropertyActionListener value="#{observer}"
                                                        target="#{bean.openedObserver}" />
                                                </p:commandButton>
                                            </p:column>
                                            <br />
                                        </p:dataList>
                                    </t:div>
                                </t:div>
                            </td>
                        </tr>
                    </table>

                </t:div>
                <t:div id="reply-container" styleClass="layout">
                    <t:div id="replies" align="center" style="border:1px solid #A6C9E2; border-radius;width:100%;"
                        rendered="${bean.editing == 0}">
                        <ui style="width:100%;">
                            <ui:repeat var="reply" value="${obj.replies}">
                                <li class="issue-comment">
                                    <h:outputText value="${reply.text}" />
                                    <h:outputText value=" -- " />
                                    <h:outputText class="comm-user" value="${reply.replier.displayName} " />
                                    <h:outputText class="comm-date" value="${reply.createdDate}" />
                                    <p:commandButton value="delete" rendered="${reply.flag}"
                                        actionListener="${bean.deleteReply(reply)}" update=":issueMainForm:replies" />
                                </li>
                            </ui:repeat>
                        </ui>
                    </t:div>

                    <h:outputText id="addComment" value="添加评论" class="toogleText" rendered="${bean.editing == 0}" />

                    <t:div id="commentView" rendered="${bean.editing == 0}">

                        <table style="margin-left:5em; width:80%;">
                            <tr>
                                <td colspan="2">
                                    <p:inputTextarea id="commentContent" value="${bean.reply.text}"
                                        rows="5" cols="80" autoResize="false" />
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <p:selectOneMenu rendered="${bean.operatable}" value="${obj.stateValue}"
                                        panelStyle="width:150px;margin-top:10px;">
                                        <f:selectItems value="${bean.issueStates}" var="item" itemLabel="${item.name}"
                                            itemValue="${item.value}" />
                                    </p:selectOneMenu>
                                </td>
                                <td>
                                    <p:commandLink value="评论" actionListener="${bean.doComment}"
                                        update=":issueMainForm:replies, :issueMainForm:issueState" />
                                    <h:outputText class="toogleText" id="cancelComment" value="取消" />
                                </td>
                            </tr>
                        </table>
                    </t:div>
                    <script type="text/javascript">
                        $("#issueMainForm\\:commentView").slideUp();

                        $("#issueMainForm\\:addComment").click(function(){
                        $("#issueMainForm\\:commentView").slideDown();
                        $(this).hide();
                        });

                        $("#issueMainForm\\:cancelComment").click(function(){
                        $("#issueMainForm\\:commentView").slideUp();
                        $("#issueMainForm\\:addComment").show();
                        });

                        function
                        clearContent(){
                        $("#issueMainForm\\:commentContent").val("");
                        }

                    </script>
                </t:div>

            </t:div>

            <p:dialog header="choose observer" widgetVar="testDialog">
                <t:div id="observercontent">
                    <h:outputText value="#{bean.openedObserver.user.displayName}" />
                    <p:selectBooleanCheckbox value="#{bean.openedObserver.manager}" />
                    <p:commandButton value="确定" actionListener="${bean.testSetProterty}" oncomplete="testDialog.hide();"
                        update=":issueMainForm:issue-observers, :issueMainForm:available-observers" />
                    <p:commandButton value="取消" onclick="testDialog.hide();" />
                </t:div>
            </p:dialog>

        </h:form>

        <style>
            .issue-id{
            font-size:40px;
            color:rgba(125, 57, 187, 0.66);
            }
            .toogleText {
            margin-left:5em;
            margin-top:5px;
            margin-bottom:3em;
            color:#888;
            margin:5px;
            display:block;
            width:60px;
            border:1px solid;
            border-radius:2px;
            }

            .toogleText:hover {
            cursor:pointer;
            background-color:#fbe254;
            color:#222;
            }

            .toogleText:active {
            background-color:#D19F8F;
            }

            .issue-comment {
            width:80%;
            list-style:none;
            margin-left:5em;
            padding-top:5px;
            padding-bottom:5px;
            font-size:14px;
            border-bottom:1px solid #cecece;
            }

            .comm-user {
            color:#962D0C;
            }
            .comm-user:hover{
            text-decoration:underLine;
            }

            .comm-date{
            color:#999;
            font-size:8px;
            }
            .comm-date:hover{
            text-decoration:underLine;
            }

            .issue-infor{
            margin-left:5em;
            }

            .favoritestar{
            display:block;
            width:30px;
            height:35px;
            overflow:hidden;
            background-repeat:
            no-repeat;
            background-image:url('star-on-star-off.png')
            }

            .issue-favoritecount-container{
            text-align: center;
            }
            .favoritecount{
            color:#d4a849;
            font-weight:bold;
            }

            .observerManage{
            display:block;
            }

            .layout{
            border:1px solid #A6C9E2;
            border-radius:5px;
            }

            .north{
            height:50px;
            }

            .west{
            width:100px;
            }

            .middle{
            width:650px;
            }

            .center{
            width:100%;
            height:100%;
            }

        </style>

    </ui:define>

</ui:composition>
