<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
    xmlns:p="http://primefaces.org/ui" xmlns:t="http://myfaces.apache.org/tomahawk" xmlns:fr="http://java.sun.com/jsf/composite/frame"
    xmlns:icsf="http://java.sun.com/jsf/composite/3/7" xmlns:sem="http://java.sun.com/jsf/composite/3/15" template="/template/simple-entity.xhtml">

    <ui:param name="oo" value="${bean.openedObject}" />
    <ui:param name="observerObj" value="${bean.observersMBean.openedObject}" />
    <ui:param name="ccGroupObj" value="${bean.ccGroupsMBean.openedObject}" />
    <ui:param name="hrefObj" value="${bean.hrefsMBean.openedObject}" />
    <ui:param name="replyObj" value="${bean.repliesMBean.openedObject}" />

    <ui:param name="_toggleable" value="${editable != false and bean.editing}" />

    <ui:define name="dataColumns">
        <p:column headerText="Á±ªÂûã" sortBy="${entry.typeChar}">
            <img src="../${entry.type.name}.png" width="24" height="24" />
            <h:outputText value="${entry.type.label}" />
        </p:column>
        <p:column headerText="Ê†áÈ¢ò" sortBy="${entry.description}">
            <h:outputText value="${entry.subject}" />
        </p:column>
        <p:column headerText="‰ºòÂÖàÁ∫ß" sortBy="${entry.priority}">
            <h:outputText value="${entry.priority}" />
        </p:column>
        <p:column headerText="Âà∞ÊúüÊó∂Èó¥" sortBy="${entry.dueDate}">
            <h:outputText value="${entry.dueDate}" />
        </p:column>
        <p:column headerText="ÁªìÊùüÊó∂Èó¥" sortBy="${entry.endTime}">
            <h:outputText value="${entry.endTime}" />
        </p:column>
        <ui:remove>
            <p:column headerText="ÂÜÖÂÆπ" sortBy="${entry.text}">
                <h:outputText value="${entry.text}" />
            </p:column>
            <p:column headerText="Ê†áÁ≠æ" sortBy="${entry.tags}">
                <h:outputText value="${entry.tags}" />
            </p:column>
        </ui:remove>
    </ui:define>

    <ui:define name="scripts.user">
        <script language="javascript" src="../issue.js"></script>
    </ui:define>

    <ui:define name="editDialogContent">
        <p:tabView id="tv">
            <p:tab id="basicTab" title="‰∫ãÂä°‰ø°ÊÅØ">
                <table width="100%">
                    <tr>
                        <td width="60" rowspan="2" align="center">
                            <h:panelGroup id="typePanel">
                                <h:inputHidden id="issueType" label="Á±ªÂûã" value="${oo.typeChar}" />
                                <p:commandLink styleClass="icon-button" title="ÂàáÊç¢Ë∞ìËØç" onclick="waitbox.show();"
                                    actionListener="${oo.switchType}" oncomplete="waitbox.hide();" update="typePanel">
                                    <img src="../${oo.type.name}.png" width="50" height="50" />
                                </p:commandLink>
                                <br />
                                <b>${oo.type.label}</b>
                            </h:panelGroup>
                        </td>
                        <td>
                            <p:inplace emptyLabel="Ê≤°ÊúâËÆæÁΩÆ‰∫ãÂä°Ê†áÈ¢ò" editor="true" toggleable="${_toggleable}" style="font-size: x-large;">
                                <p:inputText id="subject" label="Ê†áÈ¢ò" value="${oo.subject}" style="font-size: x-large; width: 100%" />
                                <p:watermark for="subject" value="ËæìÂÖ•‰∫ãÂä°ÁöÑÊ†áÈ¢ò" />
                            </p:inplace>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <ul style="list-style: none; padding: 0">
                                <li style="float: left; margin: 0 2em 0 0">
                                    <img src="${location.WEB_APP}/VAADIN/themes/activiti/img/duedate-16.png" />
                                    Âà∞ÊúüÊó∂Èó¥Ôºö

                                    <p:inplace emptyLabel="Êó†ËÆæÁΩÆ" editor="true" toggleable="${_toggleable}">
                                        <p:calendar id="dueDate" label="Âà∞ÊúüÊó∂Èó¥" pattern="yyyy-MM-dd HH:mm"
                                            navigator="${true}" value="${oo.dueDate}" showOn="button" />
                                    </p:inplace>
                                </li>
                                <li style="float: left; margin: 0 2em 0 0">
                                    <img
                                        src="${location.WEB_APP}/VAADIN/themes/activiti/img/priority-${oo.priority > 50 ? 'high' : oo.priority > 0 ? 'medium' : 'low' }-16.png" />
                                    ‰ºòÂÖàÁ∫ßÔºö
                                    <p:inplace editor="true" toggleable="${_toggleable}">
                                        <p:selectOneMenu value="${oo.priority}" style="width: 6em">
                                            <f:selectItem itemLabel="‰Ωé" itemValue="0" />
                                            <f:selectItem itemLabel="‰∏≠Á≠â" itemValue="50" />
                                            <f:selectItem itemLabel="È´ò" itemValue="100" />
                                        </p:selectOneMenu>
                                    </p:inplace>
                                </li>
                                <c:if test="${not _historicMode}">
                                    <li style="float: left; margin: 0 2em 0 0">
                                        <img src="${location.WEB_APP}/VAADIN/themes/activiti/img/create-time-16.png" />
                                        ÂàõÂª∫‰∫éÔºö${bean.relativeDateTo(oo.createdDate)}
                                    </li>
                                </c:if>
                            </ul>
                        </td>
                    </tr>
                </table>

                <p:separator />
                <p:inplace emptyLabel="Ê≠§‰∫ãÂä°Ê≤°ÊúâÂÜÖÂÆπ„ÄÇ" editor="true" toggleable="${_toggleable}" style="display: block; min-height: 10em">
                    <p:inputTextarea id="text" label="ÂÜÖÂÆπ" value="${oo.text}" style="width: 100%; min-height: 10em" />
                    <p:watermark for="text" value="ËæìÂÖ•‰∫ãÂä°ÁöÑÂÜÖÂÆπ" />
                </p:inplace>

                <p:separator />
                ‰∫ãÂä°Áä∂ÊÄÅÔºö
                <p:selectOneMenu id="state" label="‰∫ãÂä°Áä∂ÊÄÅ" value="${oo.stateInt}" style="width: 10em;">
                    <f:selectItems value="${trackDicts.states}" var="it" itemLabel="${it.label}"
                        itemValue="${it.value}" />
                </p:selectOneMenu>
            </p:tab>

            <p:tab id="bizTab" title="‰∏öÂä°">
                <h3>
                    ÈîÄÂîÆÊú∫‰ºö
                    <h:outputText value="..." styleClass="e-link" onclick="#{oo.chance.clickAction}" />
                </h3>
                <p:inplace emptyLabel="Ê≤°ÊúâÁõ∏ÂÖ≥ÁöÑÈîÄÂîÆÊú∫‰ºö„ÄÇ" editor="true" toggleable="${_toggleable}">
                    <p:inputText id="chanceLabel" label="ÈîÄÂîÆÊú∫‰ºö" value="${bean.chanceText}" size="40"
                        readonly="true" />
                    <p:commandButton id="chooseChance" value="..." onclick="chooseChanceDialog.show()" />
                </p:inplace>

                <p:separator />
                <h3>
                    Â∫ìÂ≠òÂçïÊçÆ
                    <h:outputText value="..." styleClass="e-link" onclick="#{oo.stockOrder.clickAction}" />
                </h3>
                <p:inplace emptyLabel="Ê≤°ÊúâÁõ∏ÂÖ≥ÁöÑÂ∫ìÂ≠òÂçïÊçÆ„ÄÇ" editor="true" toggleable="${_toggleable}">
                    <p:inputText id="orderLabel" label="Â∫ìÂ≠òÂçïÊçÆ" value="${bean.stockOrderText}" size="40"
                        readonly="true" />
                    <p:commandButton id="chooseStockOrder" value="..." onclick="chooseStockOrderDialog.show()" />
                </p:inplace>
            </p:tab>

            <p:tab biz="teamTab" title="ÂèÇ‰∏éËÄÖ">
                <h3>Âõ¢Èòü</h3>
                <fr:listView id="observersIndexView" header="ÊàêÂëò" style="indexPanel-bare" mbean="${bean.observersMBean}"
                    editView=":observersEditView" nested="true" paginator="false" readonly="#{not bean.editing}">
                    <f:facet name="columns">
                        <p:column headerText="Áî®Êà∑">
                            <h:outputText value="${entry.observer.displayName}" />
                        </p:column>
                        <p:column headerText="ËßíËâ≤">
                            <h:outputText value="${entry.label}" />
                        </p:column>
                        <p:column headerText="ÁÆ°ÁêÜÊùÉ">
                            <h:outputText value="${entry.manager ? '‚òë' : ''}" />
                        </p:column>
                        <p:column headerText="ÊùÉÈáç">
                            <h:outputText value="${entry.rank}" />
                        </p:column>
                        <p:column headerText="Êù•ÂÆæ">
                            <h:outputText value="${entry.rank &lt;= 0 ? 'üêµ' : ''}" />
                        </p:column>
                        <p:column headerText="Êî∂Ëóè">
                            <h:outputText value="${entry.fav ? '‚ù§' : ''}" />
                        </p:column>
                    </f:facet>
                </fr:listView>

                <p:separator />
                <h3>ÊäÑÈÄÅÁªÑ</h3>
                <fr:listView id="ccGroupsIndexView" header="Áî®Êà∑ÁªÑ" style="indexPanel-bare" mbean="${bean.ccGroupsMBean}"
                    editView=":ccGroupsEditView" nested="true" paginator="false" readonly="#{not bean.editing}">
                    <f:facet name="columns">
                        <p:column headerText="Áî®Êà∑ÁªÑ">
                            <h:outputText value="${entry.observer.displayName}" />
                        </p:column>
                        <p:column headerText="Â§áÊ≥®">
                            <h:outputText value="${entry.description}" />
                        </p:column>
                    </f:facet>
                </fr:listView>
            </p:tab>

            <p:tab id="resTab" title="Áõ∏ÂÖ≥ÂÜÖÂÆπ">
                <div style="max-height: 30em; overflow-y: auto">
                    <h3>ÂèÇËÄÉÈìæÊé•</h3>
                    <table border="0" style="width: 100%">
                        <ui:repeat value="${oo.hrefs}" var="a">
                            <tr>
                                <td width="20">
                                    <img src="${location.WEB_APP}/VAADIN/themes/activiti/img/page_white_world.png" />
                                </td>
                                <td>
                                    <a href="${a.url}" target="_blank">${a.label}</a>
                                </td>
                                <td width="30">
                                    <p:commandLink id="deleteHref" title="Âà†Èô§Ê≠§ÈìæÊé•" rendered="${editable != false}"
                                        icon="ui-icon-close" actionListener="${bean.removeHref(a.id)}" update="@form"
                                        onclick="waitbox.show()" oncomplete="waitbox.hide()">
                                        <p:graphicImage value="${location.ICON}/etool16/delete_edit.gif" />
                                    </p:commandLink>
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="color: gray">${a.description}</td>
                            </tr>
                        </ui:repeat>
                    </table>

                    <ui:fragment rendered="${editable != false}">
                        <div align="right">
                            <p:commandLink id="addURL" value="Ê∑ªÂä†ÈìæÊé•" actionListener="${bean.newHref}"
                                update=":addHrefForm" oncomplete="addHrefDialog.show()">
                                <f:attribute name="locking" value="never" />
                            </p:commandLink>
                        </div>
                    </ui:fragment>

                    <p:separator />
                    <h3>ÈôÑ‰ª∂</h3>
                    <table border="0" style="width: 100%">
                        <ui:repeat value="${oo.attachments}" var="a">
                            <tr>
                                <td width="20">
                                    <img src="${location.WEB_APP}/VAADIN/themes/activiti/img/page_white_get.png"
                                        style="display: none" />
                                    <img src="${location.ICON}/etool16/save_edit.gif" />
                                </td>
                                <td>
                                    <p:commandLink id="downloadLink" value="${a.label}" ajax="false"
                                        styleClass="locker-bypass">
                                        <f:attribute name="locking" value="never" />
                                        <p:fileDownload value="${bean.downloadFile(a)}"
                                            contentDisposition="${bean.contentDisposition(a)}" />
                                    </p:commandLink>
                                </td>
                                <td width="30">
                                    <p:commandLink id="deleteFile" title="Âà†Èô§Ê≠§ÈôÑ‰ª∂" rendered="${editable != false}"
                                        icon="ui-icon-close" actionListener="${bean.removeAttachment(a.id)}" update="@form"
                                        onclick="waitbox.show()" oncomplete="waitbox.hide()">
                                        <p:graphicImage value="${location.ICON}/etool16/delete_edit.gif" />
                                    </p:commandLink>
                                </td>
                            </tr>
                            <tr>
                                <td></td>
                                <td colspan="2" style="color: gray">${a.description}</td>
                            </tr>
                        </ui:repeat>
                    </table>

                    <ui:fragment rendered="${contrable != false}">
                        <div align="right">
                            <p:commandLink id="addFile" value="Ê∑ªÂä†ÈôÑ‰ª∂" actionListener="${bean.newFile}"
                                update=":addFileForm" oncomplete="addFileDialog.show()">
                                <f:attribute name="locking" value="never" />
                            </p:commandLink>
                        </div>
                    </ui:fragment>
                </div>
            </p:tab>

            <p:tab id="replyTab" title="ËØÑËÆ∫">
                <div id="repliesBox" style="max-height: 25em; overflow: auto">
                    <table width="100%" border="0">
                        <ui:repeat var="c" value="${bean.replies}">
                            <tr>
                                <td colspan="2">
                                    <p:separator />
                                </td>
                            </tr>
                            <tr>
                                <td width="40">
                                    <img src="${location.WEB_APP}/VAADIN/themes/activiti/img/user-32.png" />
                                </td>
                                <td>
                                    <div>
                                        <b>${c.user.displayName}</b>
                                        ËØ¥Ôºö
                                        ${c.text}
                                    </div>
                                    <div style="color: gray; font-style: italic">
                                        ${bean.relativeDateTo(c.createdDate)}
                                    </div>
                                </td>
                            </tr>
                        </ui:repeat>
                    </table>
                </div>

                <ui:fragment rendered="${contrable != false}">
                    <table width="100%">
                        <tr>
                            <td>
                                <b>${bean.loggedInUserDisplayName}</b>
                                ËØ¥Ôºö
                            </td>
                            <td>
                                <p:inputText id="replyText" label="ËØÑËÆ∫ÂÜÖÂÆπ" value="${bean.replyText}" size="40">
                                    <f:attribute name="locking" value="never" />
                                </p:inputText>
                                <p:watermark for="replyText" value="ËæìÂÖ•ËØÑËÆ∫ÂÜÖÂÆπ" />
                            </td>
                            <td>
                                <p:commandButton id="replyButton" value="ÂèëÈÄÅ" styleClass="locker-bypass"
                                    onclick="waitbox.show()"
                                    oncomplete="waitbox.hide(); rbox=$('#repliesBox'); rbox.scrollTop(rbox[0].scrollHeight);"
                                    actionListener="${bean.addReply}" update="@form">
                                    <f:attribute name="locking" value="never" />
                                </p:commandButton>
                            </td>
                            <td>
                                <p:commandButton id="refreshButton" value="Âà∑Êñ∞" styleClass="locker-bypass"
                                    onclick="waitbox.show()"
                                    oncomplete="waitbox.hide(); rbox=$('#repliesBox'); rbox.scrollTop(rbox[0].scrollHeight);"
                                    actionListener="${bean.refreshReplies}" update="@form">
                                    <f:attribute name="locking" value="never" />
                                </p:commandButton>
                            </td>
                        </tr>
                    </table>
                </ui:fragment>

                <script language="javascript">
                    var rbox=$('#repliesBox');
                    rbox.scrollTop(rbox[0].scrollHeight);
                </script>
            </p:tab>

            <ui:remove>
                <p:tab id="statingTab" title="Ë°®ÊÄÅ">
                </p:tab>
            </ui:remove>
        </p:tabView>
    </ui:define>

    <ui:define name="dialogs">
        <ui:insert name="dialogs.taskTemplate" />

        <icsf:choosePrincipalDialog id="chooseObserverDialog" var="chooseObserverDialog"
            header="ÈÄâÊã©ÂèÇ‰∏éÁöÑÁî®Êà∑" stereo="U" target="${observerObj.observer}" update=":observersEditView:editForm" />

        <icsf:choosePrincipalDialog id="chooseCcGroupDialog" var="chooseCcGroupDialog"
            header="ÈÄâÊã©ÊäÑÈÄÅÁöÑÁî®Êà∑ÁªÑ" stereo="G" target="${ccGroupObj.observer}" update=":ccGroupsEditView:editForm" />

        <sem:chooseChanceDialog id="chooseChanceDialog" var="chooseChanceDialog" header="ÈÄâÊã©ÈîÄÂîÆÊú∫‰ºö"
            target="${oo.chance}" update=":editDialog:form:tv:bizTab" />

        <sem:chooseStockOrderDialog id="chooseStockOrderDialog" var="chooseStockOrderDialog"
            header="ÈÄâÊã©Â∫ìÂ≠òÂçïÊçÆ" target="${oo.stockOrder}" update=":editDialog:form:tv:bizTab" />

        <fr:listView id="observersEditView" header="ÊàêÂëò" style="editDialog" indexView=":editDialog:form:tv:observersIndexView"
            mbean="${bean.observersMBean}" readonly="#{not bean.editing}">
            <h:panelGrid columns="2">
                <h:outputText value="Áî®Êà∑Ôºö" styleClass="e-link" onclick="#{item.observer.clickAction}" />
                <h:panelGroup>
                    <h:inputHidden id="observer" label="Áî®Êà∑" value="${item.observer.id_RZ}" />
                    <h:outputText value="${item.observer.displayName}" />
                    <p:commandButton id="chooseObserver" value="..." oncomplete="chooseObserverDialog.show()">
                        <f:setPropertyActionListener target="${choosePrincipalDialogBean.stereo}"
                            value="U" />
                    </p:commandButton>
                </h:panelGroup>

                <h:outputLabel for="label" value="ËßíËâ≤Ôºö" />
                <p:inputText id="label" label="ËßíËâ≤" value="${item.label}" />

                <h:outputLabel for="manager" value="ÁÆ°ÁêÜÊùÉÔºö" />
                <p:selectBooleanCheckbox id="manager" value="${item.manager}" />

                <h:outputLabel for="rank" value="ÊùÉÈáçÔºö" />
                <p:spinner id="rank" value="${item.rank}" min="0" max="10" />
            </h:panelGrid>
        </fr:listView>

        <fr:listView id="ccGroupsEditView" header="ÊäÑÈÄÅÁªÑ" style="editDialog" indexView=":editDialog:form:tv:ccGroupsIndexView"
            mbean="${bean.ccGroupsMBean}" readonly="#{not bean.editing}">
            <h:panelGrid columns="2">
                <h:outputText value="Áî®Êà∑ÁªÑÔºö" styleClass="e-link" onclick="#{item.observer.clickAction}" />
                <h:panelGroup>
                    <h:inputHidden id="group" label="Áî®Êà∑ÁªÑ" value="${item.observer.id_RZ}" />
                    <h:outputText value="${item.observer.displayName}" />
                    <p:commandButton id="chooseGroup" value="..." oncomplete="chooseCcGroupDialog.show()">
                        <f:setPropertyActionListener target="${choosePrincipalDialogBean.stereo}"
                            value="G" />
                    </p:commandButton>
                </h:panelGroup>

                <h:outputLabel for="description" value="Â§áÊ≥®Ôºö" />
                <p:inputText id="description" label="Â§áÊ≥®" value="${item.description}" />
            </h:panelGrid>
        </fr:listView>

        <p:dialog header="Ê∑ªÂä†ÈìæÊé•" widgetVar="addHrefDialog" modal="true" dynamic="${viewConfig.dynamicDialog}">
            <h:form id="addHrefForm" style="" rendered="${historicMode != true}">
                <h:panelGrid id="urlGrid" columns="2" columnClasses="f-right, f-left" style="width: 100%">
                    <ui:fragment>
                        <img src="${location.WEB_APP}/VAADIN/themes/activiti/img/page_white_world.png" />
                        <h:outputText value="ÈìæÊé•Âú∞ÂùÄÔºö" />
                    </ui:fragment>
                    <p:inputText id="url" label="ÈìæÊé•Âú∞ÂùÄ" value="${bean.url}" style="width: 100%" />
                    <h:outputText value="ÂêçÁß∞Ôºö" />
                    <p:inputText id="urlLabel" label="ÂêçÁß∞" value="${bean.urlLabel}" style="width: 100%" />
                    <h:outputText value="ÊèèËø∞Ôºö" />
                    <p:inputTextarea id="urlDescription" label="ÊèèËø∞" value="${bean.urlDescription}"
                        style="width: 100%" />
                </h:panelGrid>
                <p:watermark for="url" value="ËæìÂÖ•ÈìæÊé•Âú∞ÂùÄ" />
                <p:watermark for="urlLabel" value="ËæìÂÖ•ÈìæÊé•ÂêçÁß∞" />
                <p:watermark for="urlDescription" value="ËæìÂÖ•ÈìæÊé•ÊèèËø∞" />
                <p:separator />
                <div align="right">
                    <p:commandButton id="addButton" value="Á°ÆÂÆö" onclick="waitbox.show()" actionListener="${bean.addHref}"
                        oncomplete="waitbox.hide(); addHrefDialog.hideValidated(args)" update=":editDialog:form" />
                    <p:commandButton id="cancelButton" value="ÂèñÊ∂à" onclick="addHrefDialog.hide()" />
                </div>
            </h:form>
        </p:dialog>

        <sem:uploadFileDialog id="uploadFileDialog" var="uploadFileDialog"
            fileUploadListener="${bean.uploadFileListener.handleFileUpload}" update=":addFileForm" />

        <p:dialog header="Ê∑ªÂä†ÈôÑ‰ª∂" widgetVar="addFileDialog" modal="true" dynamic="${viewConfig.dynamicDialog}">
            <h:form id="addFileForm" style="" rendered="${historicMode != true}">
                <h:panelGrid id="fileGrid" columns="2" columnClasses="f-right, f-left" style="width: 100%">
                    <ui:fragment>
                        <img src="${location.WEB_APP}/VAADIN/themes/activiti/img/page_white_get.png" />
                        <h:outputText value="Êñá‰ª∂ÂêçÔºö" />
                    </ui:fragment>
                    <h:panelGroup>
                        <h:outputLabel for="uploadButton" value="${bean.filePath}" />
                        <p:commandButton id="uploadButton" value="‰∏ä‰º†" onclick="uploadFileDialog.show()" />
                    </h:panelGroup>

                    <h:outputLabel for="fileLabel" value="ÂêçÁß∞Ôºö" />
                    <p:inputText id="fileLabel" label="ÂêçÁß∞" value="${bean.fileLabel}" style="width: 100%" />

                    <h:outputLabel for="fileDescription" value="ÊèèËø∞Ôºö" />
                    <p:inputTextarea id="fileDescription" label="ÊèèËø∞" value="${bean.fileDescription}"
                        style="width: 100%" />
                </h:panelGrid>
                <p:watermark for="fileLabel" value="ËæìÂÖ•ÈôÑ‰ª∂ÂêçÁß∞" />
                <p:watermark for="fileDescription" value="ËæìÂÖ•ÈôÑ‰ª∂ÊèèËø∞" />
                <p:separator />
                <div align="right">
                    <p:commandButton id="addButton" value="Á°ÆÂÆö" onclick="waitbox.show()" actionListener="${bean.addFile}"
                        oncomplete="waitbox.hide(); addFileDialog.hideValidated(args)" update=":editDialog:form" />
                    <p:commandButton id="cancelButton" value="ÂèñÊ∂à" onclick="addFileDialog.hide()" />
                </div>
            </h:form>
        </p:dialog>

    </ui:define>

</ui:composition>
