<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:p="http://primefaces.org/ui"
    xmlns:t="http://myfaces.apache.org/tomahawk" xmlns:sem="http://java.sun.com/jsf/composite/3/15" template="/template/simple-entity.xhtml">

    <ui:param name="title" value="销售机会" />
    <ui:param name="bean" value="#{chanceBean}" />
    <ui:param name="dicts" value="#{chanceDictsBean}" />

    <ui:define name="toolbarPeripherals">
        <sem:singleVerifierSupportButton id="verifyButton" selection="#{bean.selection}" />
    </ui:define>

    <ui:define name="dataColumns">
        <p:column headerText="日期" style="width:140px;">
            <h:outputText value="#{entry.date}" />
        </p:column>

        <p:column headerText="类型" style="width:50px;">
            <h:outputText value="#{entry.category.label}" />
        </p:column>

        <p:column headerText="机会标题">
            <h:outputText value="#{entry.subject}" />
        </p:column>

        <p:column headerText="来源" style="width:80px;">
            <h:outputText value="#{entry.source.label}" />
        </p:column>

        <p:column headerText="客户">
            <h:outputText value="#{entry.partiesHint}" />
        </p:column>

        <p:column headerText="机会内容">
            <h:outputText value="#{entry.shortContent}" />
        </p:column>

        <p:column headerText="机会阶段" style="width:100px;">
            <h:outputText value="#{entry.stage.label}" />
        </p:column>

        <p:column headerText="状态">
            <h:outputText value="#{entry.verifyContext.verifyEvalState}" />
        </p:column>
    </ui:define>

    <ui:define name="editDialog">
        <p:dialog header="销售机会具体" id="editDialog" widgetVar="editDialog" modal="true" lazy="#{viewConfig.dynamicDialog}">
            <c:set var="obj" value="#{bean.activeObject}" />
            <h:form id="form" style="max-height: 30em; margin: 1em">
                <p:tabView id="tv" rendered="#{obj != null}">
                    <p:tab header="机会基本信息">
                        <t:panelGrid columns="4"
                            columnClasses="detail_col_title,detail_col_value,detail_col_title,detail_col_value">
                            <h:outputText value="机会标题:" />
                            <t:panelGroup colspan="3">
                                <p:inputText id="subject" value="#{obj.subject}" style="width:100%;" />
                            </t:panelGroup>

                            <h:outputText value="机会分类:" />
                            <p:selectOneMenu id="category" value="#{obj.category.displayId}" style="width:100px;">
                                <f:selectItems value="#{bean.category}" />
                            </p:selectOneMenu>
                            <h:outputText value="机会来源:" />
                            <p:selectOneMenu id="source" value="#{obj.source.displayId}" style="width:100px;">
                                <f:selectItems value="#{bean.source}" />
                            </p:selectOneMenu>

                            <h:outputText value="客户:" />
                            <t:panelGroup colspan="3">
                                <t:panelGrid columns="2">
                                    <p:dataTable id="chanceParties" var="_party" value="#{obj.parties}">
                                        <p:column headerText="客户名称" style="width:150px">
                                            <h:outputText value="#{_party.party.displayName}" />
                                        </p:column>

                                        <p:column headerText="角色" style="width:150px">
                                            <h:outputText value="#{_party.role}" />
                                        </p:column>

                                        <p:column headerText="操作" style="width:70px">
                                            <p:commandLink update=":chancePartyEditForm:chancePartyItem"
                                                title="编辑" oncomplete="changePartyDialog.show();" style="padding: 4px;">
                                                <p:graphicImage value="#{location.ICON}/etool16/validate.gif" />
                                                <f:setPropertyActionListener value="#{_party}"
                                                    target="#{obj.selectedParty}" />
                                            </p:commandLink>
                                            <p:commandLink title="删除" oncomplete="chancePartyConfirmation.show();"
                                                disabled="#{bean.chances.selected}" style="padding: 4px;">
                                                <p:graphicImage value="#{location.ICON}/etool16/delete_edit.gif" />
                                                <f:setPropertyActionListener value="#{_party}"
                                                    target="#{obj.selectedParty}" />
                                            </p:commandLink>
                                        </p:column>

                                    </p:dataTable>
                                    <p:commandButton value="..." onclick="chooseChancePartyDialog.show()"
                                        title="选择客户" />
                                </t:panelGrid>
                            </t:panelGroup>

                            <h:outputText value="机会地址:" />
                            <t:panelGroup colspan="3">
                                <p:inputText id="address" value="#{obj.address}" style="width:100%;" />
                            </t:panelGroup>

                            <h:outputText for="content" value="机会内容:" />
                            <t:panelGroup colspan="3">
                                <p:inputTextarea id="content" value="#{obj.content}" style="width:100%;height:60px;" />
                            </t:panelGroup>

                            <h:outputText for="stage" value="机会阶段:" />
                            <t:panelGroup colspan="3">
                                <p:selectOneMenu id="stage" value="#{obj.stage.displayId}" style="width:120px;"
                                    disabled="true">
                                    <f:selectItems value="#{bean.stage}" />
                                </p:selectOneMenu>
                            </t:panelGroup>
                        </t:panelGrid>
                    </p:tab>

                    <p:tab header="日志历史记录">
                        <p:toolbar id="actionToolbar">
                            <p:toolbarGroup align="left">
                                <p:commandButton id="relateActionButton" value="增加关联" actionListener="#{bean.initActions}"
                                    update=":dialogForm:actionCopyList" oncomplete="chooseChanceActionDialog.show();" />
                                <p:commandButton id="unrelateActionButton" value="取消关联"
                                    onclick="deleteActionConfirm.show();" disabled="#{bean.selectedAction == null}" />
                                <p:commandButton id="viewActionDetailButton" value="详细"
                                    actionListener="#{bean.viewActionDetail}" update=":dialogForm:actionDetail"
                                    oncomplete="actionDetailDialog.show();" disabled="#{bean.selectedAction == null}" />
                            </p:toolbarGroup>
                        </p:toolbar>
                        <p:dataTable id="actionHistories" var="action" value="#{_c.actions}" selection="#{_c.selectedAction}"
                            selectionMode="single" rowKey="#{action.id}" rowIndexVar="rowIndex">

                            <p:ajax event="rowSelect" update=":chanceForm:mainTab:actionToolbar" />

                            <p:column headerText="序号" style="width:45px;">
                                <h:outputText value="#{rowIndex + 1}" />
                            </p:column>

                            <p:column headerText="日期">
                                <h:outputText value="#{action.date}" />
                            </p:column>

                            <p:column headerText="时间段">
                                <h:outputText value="#{action.timeRange}" />
                            </p:column>

                            <p:column headerText="类型">
                                <h:outputText value="#{action.actionType}" />
                            </p:column>

                            <p:column headerText="洽谈类型">
                                <h:outputText value="#{action.style.label}" />
                            </p:column>

                            <p:column headerText="行动简略">
                                <h:outputText value="#{action.subject}" />
                            </p:column>

                            <p:column headerText="机会阶段">
                                <h:outputText value="#{action.stage.label}" />
                            </p:column>

                        </p:dataTable>
                    </p:tab>

                    <p:tab header="报价">
                        <p:toolbar id="quotationToolbar">
                            <p:toolbarGroup align="left">
                                <p:commandButton id="chanceNewQuotationButton" value="添加"
                                    actionListener="#{bean.createQuotationForm}" oncomplete="quotationDialog.show();"
                                    update=":quotationForm:quotationGrid" />
                                <p:commandButton id="chanceEditQuotationButton" value="编辑"
                                    actionListener="#{bean.editQuotation}" oncomplete="quotationDialog.show();" update=":quotationForm:quotationGrid"
                                    disabled="#{bean.selectedQuotation == null}" />
                                <p:commandButton id="chanceDeleteQuotationButton" value="删除"
                                    onclick="quotationConfirmation.show();" disabled="#{bean.selectedQuotation == null}" />
                                <p:commandButton id="chanceViewQuotationButton" value="详细"
                                    actionListener="#{bean.viewQuotationDetail}" oncomplete="quotationDialog.show();"
                                    update=":quotationForm:quotationGrid" disabled="#{bean.selectedQuotation == null}" />
                            </p:toolbarGroup>
                        </p:toolbar>
                        <p:dataTable id="quotationList" rowIndexVar="rowIndex" value="#{bean.quotations.list}"
                            selection="#{bean.quotations.selection}" selectionMode="single" rowKey="#{item.id}" var="item">

                            <p:ajax event="rowSelect" update=":chanceForm:mainTab:quotationToolbar" />

                            <p:column headerText="序号" style="width:45px;">
                                <h:outputText value="#{rowIndex + 1}" />
                            </p:column>
                            <p:column headerText="标题">
                                <h:outputText value="#{item.subject}" />
                            </p:column>
                            <p:column headerText="报价日期">
                                <h:outputText value="#{item.createdDate}" />
                            </p:column>
                            <p:column headerText="总金额">
                                <h:outputText value="#{item.nativeTotal}" />
                            </p:column>
                        </p:dataTable>
                    </p:tab>
                </p:tabView>
            </h:form>
        </p:dialog>
    </ui:define>

    <ui:define name="dialogs">
        <sem:singleVerifierSupportDialog update="chanceForm" />

        <p:confirmDialog message="确定要删除此报价单吗?" showEffect="bounce" hideEffect="explode" header="note"
            severity="alert" widgetVar="quotationConfirmation">
            <h:form>
                <p:commandButton value="删除"
                    update=":chanceForm:mainTab:quotationToolbar, :chanceForm:mainTab:quotationList" oncomplete="quotationConfirmation.hide()"
                    actionListener="#{bean.dropQuotation}" async="true" />
                <p:commandButton value="取消" onclick="quotationConfirmation.hide()" type="button" />
            </h:form>
        </p:confirmDialog>

        <p:confirmDialog message="确定要取消此行动记录的关联?" hideEffect="explode" header="注意" severity="alert"
            widgetVar="deleteActionConfirm">
            <h:form>
                <p:commandButton value="确定" actionListener="#{bean.detachAction}"
                    update=":chanceForm:mainTab:actionHistories, :chanceForm:mainTab:actionToolbar" oncomplete="deleteActionConfirm.hide();" />
                <p:commandButton value="取消" onclick="deleteActionConfirm.hide();" />
            </h:form>
        </p:confirmDialog>

        <p:dialog header="行动记录详细" widgetVar="actionDetailDialog" modal="true">
            <c:set var="obj" value="#{bean.selectedAction}" />
            <h:form id="actionDetail">
                <t:panelGrid rendered="#{obj != null}" columns="4"
                    columnClasses="detail_col_title,detail_col_value,detail_col_title,detail_col_value">

                    <h:outputText value="开始时间:" />
                    <p:calendar id="beginTime" pattern="yyyy-MM-dd HH:mm" navigator="#{true}" value="#{obj.beginTime}"
                        showOn="button" disabled="#{true}" />
                    <h:outputText value="结束时间:" />
                    <p:calendar id="endTime" pattern="yyyy-MM-dd HH:mm" navigator="#{true}" value="#{obj.endTime}"
                        showOn="button" disabled="#{true}" />

                    <h:outputText value="日志类型:" />
                    <p:selectOneMenu id="actionStyle" value="#{obj.plan}" style="width:100px;" disabled="#{true}">
                        <f:selectItem itemLabel="计划" itemValue="#{true}" />
                        <f:selectItem itemLabel="日志" itemValue="#{false}" />
                    </p:selectOneMenu>

                    <h:outputText value="洽谈方式:" />
                    <p:selectOneMenu id="style" value="#{obj.style.displayId}" style="width: 100px;"
                        disabled="#{true}">
                        <f:selectItems value="#{bean.chanceActionStyles}" />
                    </p:selectOneMenu>

                    <h:outputText value="拜访客户:" />
                    <p:dataList var="party" value="#{obj.parties}" effectSpeed="fast">
                        <p:column>
                            <h:outputText value="#{party.displayName}" />
                        </p:column>
                    </p:dataList>
                    <h:outputText value="工作伙伴:" />
                    <p:dataList id="partners" var="partner" value="#{obj.partners}" effectSpeed="fast">
                        <p:column>
                            <h:outputText value="#{partner.displayName}" />
                        </p:column>
                    </p:dataList>

                    <h:outputText value="内容描述:" />
                    <t:panelGroup colspan="3">
                        <p:inputTextarea id="description" value="#{obj.moreInfo}" style="width:400px;height:50px;"
                            readonly="#{true}" />
                    </t:panelGroup>

                    <h:outputText value="花费详细:" />
                    <t:panelGroup colspan="3">
                        <p:inputTextarea id="spending" value="#{obj.spending}" style="width:400px;height:50px;"
                            readonly="#{true}" />
                    </t:panelGroup>

                    <h:outputText value="机会标题:" />
                    <t:panelGroup colspan="3">
                        <p:inputText id="chanceSubject" readonly="true" value="#{obj.chance.subject}" style="width:300px" />
                    </t:panelGroup>

                    <h:outputText value="机会阶段:" />
                    <t:panelGroup colspan="3">
                        <p:selectOneMenu id="stage" value="#{obj.stage.displayId}" disabled="#{true}"
                            style="width:200px;">
                            <f:selectItem itemLabel="请选择机会阶段" itemValue="" />
                            <f:selectItems value="#{bean.stage}" />
                        </p:selectOneMenu>
                    </t:panelGroup>
                </t:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog header="编辑客户角色" modal="true" widgetVar="changePartyDialog" height="300" width="350">
            <c:set var="_sp" value="#{bean.selectedParty}" />
            <h:form id="chancePartyEditForm">
                <t:panelGrid columns="3" id="chancePartyItem">
                    <h:outputText value="客户名称:" />
                    <t:panelGroup colspan="2">
                        <h:outputText value="#{_sp.party.displayName}" />
                    </t:panelGroup>

                    <h:outputText value="角色:" />
                    <t:panelGroup colspan="2" id="role">
                        <t:panelGrid columns="5">
                            <h:outputText value="#{_sp.role}" rendered="#{!bean.roleRendered}" />
                            <p:inputText value="#{_sp.role}" rendered="#{bean.roleRendered}">
                            </p:inputText>
                            <p:commandLink title="修改" actionListener="#{bean.editCustomerRole}" rendered="#{!bean.roleRendered}"
                                update="chancePartyItem">
                                <span class="ui-icon ui-icon-pencil"></span>
                            </p:commandLink>
                            <p:commandLink title="确定" actionListener="#{bean.editCustomerRole}" update="chancePartyEditForm:role"
                                rendered="#{bean.roleRendered}">
                                <span class="ui-icon ui-icon-check"></span>
                            </p:commandLink>
                        </t:panelGrid>
                    </t:panelGroup>

                    <t:panelGroup colspan="3">
                        <p:commandButton value="确定" oncomplete="changePartyDialog.hide();" update=":chanceForm:mainTab:chanceParties" />
                        <p:commandButton value="取消" onclick="changePartyDialog.hide();" />
                    </t:panelGroup>
                </t:panelGrid>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>
