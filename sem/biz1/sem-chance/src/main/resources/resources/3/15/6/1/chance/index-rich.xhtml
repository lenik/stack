<ui:composition template="/template/simple-entity.xhtml" xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:p="http://primefaces.org/ui" xmlns:t="http://myfaces.apache.org/tomahawk" xmlns:fr="http://java.sun.com/jsf/composite/frame"
    xmlns:sem="http://java.sun.com/jsf/composite/3/15">

    <ui:param name="title" value="销售机会" />
    <ui:param name="bean" value="#{chanceBean}" />
    <ui:param name="obj" value="#{bean.activeObject}" />
    <ui:param name="dicts" value="#{chanceDictsBean}" />

    <ui:define name="toolbarPeripherals">
        <sem:singleVerifierSupportButton id="verifyButton" selection="#{bean.selection}" />
    </ui:define>

    <ui:define name="dataColumns">
        <p:column headerText="日期" style="width:140px;">
            <h:outputText value="#{entry.date}" />
        </p:column>

        <p:column headerText="类型" style="width:50px;">
            <h:outputText value="#{entry.category.label}" />
        </p:column>

        <p:column headerText="机会标题">
            <h:outputText value="#{entry.subject}" />
        </p:column>

        <p:column headerText="来源" style="width:80px;">
            <h:outputText value="#{entry.source.label}" />
        </p:column>

        <ui:remove>
            <p:column headerText="客户">
                <h:outputText value="#{entry.partiesHint}" />
            </p:column>
        </ui:remove>

        <p:column headerText="机会内容">
            <h:outputText value="#{entry.shortContent}" />
        </p:column>

        <p:column headerText="机会阶段" style="width:100px;">
            <h:outputText value="#{entry.stage.label}" />
        </p:column>

        <p:column headerText="状态">
            <h:outputText value="#{entry.verifyContext.verifyEvalState}" />
        </p:column>
    </ui:define>

    <ui:define name="editDialogContent">
        <p:tabView id="tv">
            <p:tab title="机会基本信息">
                <t:panelGrid columns="4" columnClasses="detail_col_title,detail_col_value,detail_col_title,detail_col_value">
                    <h:outputText value="机会标题:" />
                    <t:panelGroup colspan="3">
                        <p:inputText id="subject" value="#{obj.subject}" style="width:100%;" />
                    </t:panelGroup>

                    <h:outputText value="机会分类:" />
                    <p:selectOneMenu id="category" value="#{obj.category.displayId}" style="width:100px;">
                        <f:selectItems value="#{obj.category}" />
                    </p:selectOneMenu>
                    <h:outputText value="机会来源:" />
                    <p:selectOneMenu id="source" value="#{obj.source.displayId}" style="width:100px;">
                        <f:selectItems value="#{obj.source}" />
                    </p:selectOneMenu>

                    <h:outputText value="机会地址:" />
                    <t:panelGroup colspan="3">
                        <p:inputText id="address" value="#{obj.address}" style="width:100%;" />
                    </t:panelGroup>

                    <h:outputText for="content" value="机会内容:" />
                    <t:panelGroup colspan="3">
                        <p:inputTextarea id="content" value="#{obj.content}" style="width:100%;height:60px;" />
                    </t:panelGroup>

                    <h:outputText for="stage" value="机会阶段:" />
                    <t:panelGroup colspan="3">
                        <p:selectOneMenu id="stage" value="#{obj.stage.displayId}" style="width:120px;"
                            disabled="true">
                            <f:selectItems value="#{obj.stage}" />
                        </p:selectOneMenu>
                    </t:panelGroup>
                </t:panelGrid>
            </p:tab>

            <p:tab title="客户">
                <fr:listView id="partiesView" header="客户" style="panel" orientation="lr" mbean="#{bean.partiesMBean}"
                    smooth="true" nested="true">
                    <f:facet name="columns">
                        <p:column headerText="客户">
                            <h:outputText value="#{_party.party.displayName}" />
                        </p:column>
                        <p:column headerText="角色">
                            <h:outputText value="#{_party.role}" />
                        </p:column>
                    </f:facet>
                    <h:panelGrid columns="2">
                        <h:outputText value="客户:" />
                        <h:outputText value="#{item.party.displayName}" />
                        <h:outputLabel for="role" value="角色:" />
                        <p:inputText id="role" value="#{item.role}" />
                    </h:panelGrid>
                </fr:listView>
            </p:tab>

            <p:tab title="行动跟踪">
                <p:toolbar id="toolbar">
                    <p:toolbarGroup align="left">
                        <p:commandButton id="relateActionButton" value="增加关联" actionListener="#{bean.initActions}"
                            update=":dialogForm:actionCopyList" oncomplete="chooseChanceActionDialog.show();" />
                        <p:commandButton id="unrelateActionButton" value="取消关联" onclick="deleteActionConfirm.show();"
                            disabled="#{bean.selectedAction == null}" />
                        <p:commandButton id="viewActionDetailButton" value="详细" actionListener="#{bean.viewActionDetail}"
                            update=":actionDetailForm" oncomplete="actionDetailDialog.show();" disabled="#{bean.selectedAction == null}" />
                    </p:toolbarGroup>
                </p:toolbar>
                <p:dataTable id="actionTable" var="action" value="#{obj.actions}" selection="#{bean.selectedAction}"
                    selectionMode="single" rowKey="#{action.id}" rowIndexVar="rowIndex">

                    <p:ajax event="rowSelect" update=":editDialog:form:tv:toolbar" />

                    <p:column headerText="序号" style="width:45px;">
                        <h:outputText value="#{rowIndex + 1}" />
                    </p:column>

                    <p:column headerText="日期">
                        <h:outputText value="#{action.date}" />
                    </p:column>

                    <p:column headerText="时间段">
                        <h:outputText value="#{action.timeRange}" />
                    </p:column>

                    <p:column headerText="类型">
                        <h:outputText value="#{action.plan ? '计划' : '日志'}" />
                    </p:column>

                    <p:column headerText="洽谈类型">
                        <h:outputText value="#{action.style.label}" />
                    </p:column>

                    <p:column headerText="行动简略">
                        <h:outputText value="#{action.subject}" />
                    </p:column>

                    <p:column headerText="机会阶段">
                        <h:outputText value="#{action.stage.label}" />
                    </p:column>

                </p:dataTable>
            </p:tab>

            <p:tab title="报价">
                <fr:listView id="quotationsIndexView" editView=":quotationsEditView" header="报价" style="indexPanel"
                    orientation="td" mbean="${bean.quotationsMBean}" nested="true">
                    <f:facet name="columns">
                        <p:column headerText="标题">
                            <h:outputText value="#{entry.label}" />
                        </p:column>
                        <p:column headerText="报价日期">
                            <h:outputText value="#{entry.createdDate}" />
                        </p:column>
                        <p:column headerText="总金额">
                            <h:outputText value="#{entry.nativeTotal}" />
                        </p:column>
                    </f:facet>
                </fr:listView>
            </p:tab>
        </p:tabView>
    </ui:define>

    <ui:define name="dialogs">
        <sem:singleVerifierSupportDialog update="editDialog:form" />

        <fr:listView id="quotationsEditView" indexView=":quotationsIndexView" header="报价" style="editDialog"
            mbean="${bean.quotationsMBean}">
            <p:tabView id="tv">
                <p:tab title="报价说明">
                    <h:panelGrid columns="2">
                        <h:outputLabel for="subject" value="标题:" />
                        <p:inputText id="subject" value="#{item.label}" style="width:300px;" />

                        <h:outputLabel for="chance" value="机会:" />
                        <p:inputText id="chance" value="#{item.chance.subject}" style="width:300px;"
                            readonly="true" />

                        <h:outputText value="交付说明:" />
                        <p:inputTextarea id="recommend" value="#{item.recommend}" style="width:300px; height:60px;" />

                        <h:outputText value="付款说明:" />
                        <p:inputTextarea id="payment" value="#{item.payment}" style="width:300px; height:60px;" />
                    </h:panelGrid>
                </p:tab>
                <p:tab title="报价明细">
                    <fr:listView id="quotationItemsView" header="报价明细" style="panel" orientation="td"
                        mbean="${bean.quotationItemsMBean}" nested="true" indexView=":quotationsEditView:editForm:tv:quotationItemsView"
                        editView=":quotationsEditView:editForm:tv:quotationItemsView">
                        <f:facet name="columns">
                            <p:column headerText="产品" style="width:70px;">
                                <h:outputText value="#{entry.material.label}" />
                            </p:column>

                            <p:column headerText="折扣" style="width:80px;">
                                <h:outputText value="#{entry.discount}" />
                            </p:column>

                            <p:column headerText="基础价格" style="width:80px;">
                                <h:outputText value="#{entry.basePrice}" />
                            </p:column>

                            <p:column headerText="单价" style="width:80px;">
                                <h:outputText value="#{entry.price}" />
                            </p:column>

                            <p:column headerText="数目" style="width:50px;">
                                <h:outputText value="#{entry.quantity}" />
                            </p:column>
                        </f:facet>
                        <h:panelGrid columns="2">
                            <h:outputText value="产品/物料" />
                            <h:outputText id="material" value="#{item.material.label}" />

                            <h:outputText value="基础价格" />
                            <h:outputText value="#{item.basePrice}" />

                            <h:outputText value="折扣" />
                            <p:inputText id="discount" value="#{item.discount}" />

                            <h:outputText value="单价" />
                            <p:inputText id="price" value="#{item.price.value}" />

                            <h:outputText value="数量" />
                            <p:inputText id="quantity" value="#{item.quantity}" />
                        </h:panelGrid>
                    </fr:listView>
                </p:tab>
            </p:tabView>
        </fr:listView>

        <p:confirmDialog message="确定要取消此行动记录的关联?" hideEffect="explode" header="注意" severity="alert"
            widgetVar="deleteActionConfirm">
            <h:form>
                <p:commandButton value="确定" actionListener="#{bean.detachAction}"
                    update=":editDialog:form:tv:actionTable, :editDialog:form:tv:toolbar" oncomplete="deleteActionConfirm.hide();" />
                <p:commandButton value="取消" onclick="deleteActionConfirm.hide();" />
            </h:form>
        </p:confirmDialog>

        <p:dialog header="行动记录详细" widgetVar="actionDetailDialog" modal="true">
            <c:set var="action" value="#{bean.selectedAction}" />
            <h:form id="actionDetailForm">
                <t:panelGrid rendered="#{action != null}" columns="4"
                    columnClasses="detail_col_title,detail_col_value,detail_col_title,detail_col_value">

                    <h:outputText value="开始时间:" />
                    <p:calendar id="beginTime" pattern="yyyy-MM-dd HH:mm" navigator="#{true}" value="#{action.beginTime}"
                        showOn="button" disabled="#{true}" />
                    <h:outputText value="结束时间:" />
                    <p:calendar id="endTime" pattern="yyyy-MM-dd HH:mm" navigator="#{true}" value="#{action.endTime}"
                        showOn="button" disabled="#{true}" />

                    <h:outputText value="日志类型:" />
                    <p:selectOneMenu id="actionStyle" value="#{action.plan}" style="width:100px;"
                        disabled="#{true}">
                        <f:selectItem itemLabel="计划" itemValue="#{true}" />
                        <f:selectItem itemLabel="日志" itemValue="#{false}" />
                    </p:selectOneMenu>

                    <h:outputText value="洽谈方式:" />
                    <p:selectOneMenu id="style" value="#{action.style.displayId}" style="width: 100px;"
                        disabled="#{true}">
                        <f:selectItems value="#{bean.chanceActionStyles}" />
                    </p:selectOneMenu>

                    <h:outputText value="拜访客户:" />
                    <p:dataList var="party" value="#{action.parties}" effectSpeed="fast">
                        <p:column>
                            <h:outputText value="#{party.displayName}" />
                        </p:column>
                    </p:dataList>
                    <h:outputText value="工作伙伴:" />
                    <p:dataList id="partners" var="partner" value="#{action.partners}" effectSpeed="fast">
                        <p:column>
                            <h:outputText value="#{partner.displayName}" />
                        </p:column>
                    </p:dataList>

                    <h:outputText value="内容描述:" />
                    <t:panelGroup colspan="3">
                        <p:inputTextarea id="description" value="#{action.moreInfo}" style="width:400px;height:50px;"
                            readonly="#{true}" />
                    </t:panelGroup>

                    <h:outputText value="花费详细:" />
                    <t:panelGroup colspan="3">
                        <p:inputTextarea id="spending" value="#{action.spending}" style="width:400px;height:50px;"
                            readonly="#{true}" />
                    </t:panelGroup>

                    <h:outputText value="机会标题:" />
                    <t:panelGroup colspan="3">
                        <p:inputText id="chanceSubject" readonly="true" value="#{action.chance.subject}"
                            style="width:300px" />
                    </t:panelGroup>

                    <h:outputText value="机会阶段:" />
                    <t:panelGroup colspan="3">
                        <p:selectOneMenu id="stage" value="#{action.stage.displayId}" disabled="#{true}"
                            style="width:200px;">
                            <f:selectItem itemLabel="请选择机会阶段" itemValue="" />
                            <f:selectItems value="#{bean.stage}" />
                        </p:selectOneMenu>
                    </t:panelGroup>
                </t:panelGrid>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>
