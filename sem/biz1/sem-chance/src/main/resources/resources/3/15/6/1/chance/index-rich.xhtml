<ui:composition template="/template/simple-entity.xhtml" xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jsp/jstl/core"
    xmlns:p="http://primefaces.org/ui" xmlns:t="http://myfaces.apache.org/tomahawk" xmlns:fr="http://java.sun.com/jsf/composite/frame"
    xmlns:sem="http://java.sun.com/jsf/composite/3/15">

    <ui:param name="title" value="销售机会" />
    <ui:param name="verifiable" value="true" />
    <ui:param name="bean" value="${chanceBean}" />
    <ui:param name="obj" value="${bean.openedObject}" />
    <ui:param name="partyObj" value="${bean.partiesMBean.openedObject}" />
    <ui:param name="actionObj" value="${bean.actionsMBean.openedObject}" />
    <ui:param name="productObj" value="${bean.productsMBean.openedObject}" />
    <ui:param name="dicts" value="${chanceDictsBean}" />
    <ui:param name="monetary" value="#{monetaryDictsBean}" />
    <ui:param name="thing" value="#{thingDictsBean}" />

    <ui:define name="dataColumns">
        <p:column headerText="日期" sortBy="${entry.beginDate}" styleClass="f-wrappable">
            <h:outputText value="${entry.date}" />
        </p:column>
        <p:column headerText="类型" sortBy="${entry.category}">
            <h:outputText value="${entry.category.label}" />
        </p:column>
        <p:column headerText="机会标题" sortBy="${entry.subject}" styleClass="f-wrappable">
            <h:outputText value="${entry.subject}" />
        </p:column>
        <p:column headerText="来源" sortBy="${entry.source}">
            <h:outputText value="${entry.source.label}" />
        </p:column>
        <ui:remove>
            <p:column headerText="客户">
                <h:outputText value="${entry.partiesHint}" />
            </p:column>
        </ui:remove>
        <p:column headerText="机会内容" styleClass="f-wrappable">
            <h:outputText value="${entry.shortContent}" />
        </p:column>
        <p:column headerText="机会阶段" sortBy="${entry.stage}">
            <h:outputText value="${entry.stage.label}" />
        </p:column>
    </ui:define>

    <ui:define name="editDialogContent">
        <p:tabView id="tv">
            <p:tab title="机会基本信息">
                <t:panelGrid columns="4" columnClasses="field-label, field-content, field-label, field-content">
                    <h:outputLabel for="subject" value="机会标题:" />
                    <t:panelGroup colspan="3">
                        <p:inputText id="subject" label="机会标题" value="${obj.subject}" style="width: 100%;" />
                    </t:panelGroup>

                    <h:outputLabel for="category" value="机会分类:" />
                    <p:selectOneMenu id="category" label="机会分类" value="${obj.category.displayId}" style="width: 10em;">
                        <f:selectItems value="${dicts.categories}" var="it" itemLabel="${it.label}"
                            itemValue="${it.id}" />
                    </p:selectOneMenu>
                    <h:outputLabel for="source" value="机会来源:" />
                    <p:selectOneMenu id="source" label="机会来源" value="${obj.source.id}" style="width: 10em;">
                        <f:selectItems value="${dicts.sourceTypes}" var="it" itemLabel="${it.label}"
                            itemValue="${it.id}" />
                    </p:selectOneMenu>

                    <h:outputLabel for="address" value="机会地址:" />
                    <t:panelGroup colspan="3">
                        <p:inputText id="address" label="机会地址" value="${obj.address}" style="width: 100%;" />
                    </t:panelGroup>

                    <h:outputLabel for="content" value="机会内容:" />
                    <t:panelGroup colspan="3">
                        <p:inputTextarea id="content" label="机会内容" value="${obj.content}" style="width: 100%;height:  6em;" />
                    </t:panelGroup>

                    <h:outputLabel for="stage" value="机会阶段:" />
                    <t:panelGroup colspan="3">
                        <p:selectOneMenu id="stage" label="机会阶段" value="${obj.stage.displayId}" style="width: 12em;"
                            disabled="true">
                            <f:selectItems value="${dicts.stages}" var="it" itemLabel="${it.label}"
                                itemValue="${it.id}" />
                        </p:selectOneMenu>
                    </t:panelGroup>
                </t:panelGrid>
            </p:tab>

            <p:tab title="客户">
                <fr:listView id="partiesIndexView" header="客户" style="indexPanel" mbean="${bean.partiesMBean}"
                    editView=":partiesEditView" nested="true" paginator="false" readonly="#{not bean.editing}">
                    <f:facet name="columns">
                        <p:column headerText="客户">
                            <h:outputText value="${entry.party.displayName}" />
                        </p:column>
                        <p:column headerText="角色">
                            <h:outputText value="${entry.role}" />
                        </p:column>
                    </f:facet>
                </fr:listView>
            </p:tab>

            <p:tab title="行动跟踪">
                <fr:listView id="actionsIndexView" header="行动记录" style="indexPanel" picker="chooseChanceActionDialog"
                    editView=":actionsEditView" mbean="${bean.actionsMBean}" nested="true" readonly="#{not bean.editing}">
                    <f:facet name="columns">
                        <p:column headerText="日期">
                            <h:outputText value="${entry.date}" />
                        </p:column>
                        <p:column headerText="类型">
                            <h:outputText value="${entry.plan ? '计划' : '日志'}" />
                        </p:column>
                        <p:column headerText="执行">
                            <h:outputText value="${entry.actor.displayName}" />
                        </p:column>
                        <p:column headerText="洽谈类型">
                            <h:outputText value="${entry.style.label}" />
                        </p:column>
                        <p:column headerText="行动简略">
                            <h:outputText value="${entry.subject}" />
                        </p:column>
                        <p:column headerText="机会阶段">
                            <h:outputText value="${entry.stage.label}" />
                        </p:column>
                    </f:facet>
                </fr:listView>
            </p:tab>

            <p:tab title="选型">
                <fr:listView id="pIndexView" header="选型" style="indexPanel" editView=":pEditView" mbean="${bean.productsMBean}"
                    nested="true" readonly="#{not bean.editing}">
                    <f:facet name="columns">
                        <p:column headerText="客户名称">
                            <h:outputText value="${entry.productName}" />
                        </p:column>
                        <p:column headerText="客户型号">
                            <h:outputText value="${entry.modelSpec}" />
                        </p:column>
                        <p:column headerText="客户单位">
                            <h:outputText value="${entry.unit.label}" />
                        </p:column>
                        <p:column headerText="对应物料">
                            <h:outputText value="${entry.decidedMaterial.label}" />
                        </p:column>
                    </f:facet>
                </fr:listView>
            </p:tab>
        </p:tabView>
    </ui:define>

    <ui:define name="dialogs">
        <sem:choosePartyDialog id="c_party" header="选择机会客户" var="chooseCustomerDialog" target="${partyObj.party}"
            update=":partiesEditView:editForm" />
        <sem:chooseChanceActionDialog id="c_action" header="选择要关联的行动日志" target="${bean.actionsMBean.addition}"
            update=":editDialog:form:tv:actionsIndexView:indexForm:body" />
        <sem:chooseMaterialDialog id="c_material" header="选择产品/物料" target="${productObj.decidedMaterial}"
            update=":pEditView:editForm:tv:decidedMaterial" />

        <fr:listView id="actionsEditView" header="行动记录" style="editDialog" picker="chooseChanceActionDialog"
            indexView=":editDialog:form:tv:actionsIndexView" mbean="${bean.actionsMBean}" readonly="true">
            <t:panelGrid columns="4" columnClasses="field-label, field-content, field-label, field-content">

                <h:outputText value="开始时间:" />
                <p:calendar id="beginTime" pattern="yyyy-MM-dd HH:mm" navigator="${true}" value="${item.beginTime}"
                    showOn="button" disabled="${true}" label="开始时间" />
                <h:outputText value="结束时间:" />
                <p:calendar id="endTime" pattern="yyyy-MM-dd HH:mm" navigator="${true}" value="${item.endTime}"
                    showOn="button" disabled="${true}" label="结束时间" />

                <h:outputText value="日志类型:" />
                <p:selectOneRadio id="actionStyle" value="${item.plan}" style="width: 10em;"
                    disabled="${true}" label="日志类型">
                    <f:selectItem itemLabel="计划" itemValue="${true}" />
                    <f:selectItem itemLabel="日志" itemValue="${false}" />
                </p:selectOneRadio>

                <h:outputText value="洽谈方式:" />
                <p:selectOneMenu id="style" value="${item.style.displayId}" disabled="${true}" label="洽谈方式">
                    <f:selectItems value="${dicts.actionStyles}" var="it" itemLabel="${it.label}"
                        itemValue="${it.id}" />
                </p:selectOneMenu>

                <h:outputText value="拜访客户:" />
                <p:dataList var="party" value="${item.parties}" effectSpeed="fast">
                    <p:column>
                        <h:outputText value="${party.displayName}" />
                    </p:column>
                </p:dataList>
                <h:outputText value="工作伙伴:" />
                <p:dataList id="partners" var="partner" value="${item.partners}" effectSpeed="fast">
                    <p:column>
                        <h:outputText value="${partner.displayName}" />
                    </p:column>
                </p:dataList>

                <h:outputText value="内容描述:" />
                <t:panelGroup colspan="3">
                    <p:inputTextarea id="description" value="${item.moreInfo}" style="width: 90%;height: 8em;"
                        readonly="${true}" label="内容描述" />
                </t:panelGroup>

                <h:outputText value="花费详细:" />
                <t:panelGroup colspan="3">
                    <p:inputTextarea id="spending" value="${item.spending}" style="width: 90%;height: 2em;"
                        readonly="${true}" label="花费详细" />
                </t:panelGroup>

                <h:outputText value="机会标题:" />
                <t:panelGroup colspan="3">
                    <p:inputText id="chanceSubject" readonly="true" value="${item.chance.subject}" style="width: 30em"
                        label="机会标题" />
                </t:panelGroup>

                <h:outputText value="机会阶段:" />
                <t:panelGroup colspan="3">
                    <p:selectOneMenu id="stage" value="${item.stage.displayId}" disabled="${true}"
                        style="width: 20em;" label="机会阶段">
                        <f:selectItem itemLabel="请选择机会阶段" itemValue="" />
                        <f:selectItems value="${dicts.stages}" var="it" itemLabel="${it.label}" itemValue="${it.id}" />
                    </p:selectOneMenu>
                </t:panelGroup>
            </t:panelGrid>
        </fr:listView>

        <fr:listView id="pEditView" header="选型" style="editDialog" indexView=":editDialog:form:tv:pIndexView"
            mbean="${bean.productsMBean}" readonly="#{not bean.editing}">

            <p:tabView id="tv">
                <p:tab title="基本信息">
                    <t:panelGrid columns="2" columnClasses="field-label-long, field-content, field-label, field-content">

                        <h:outputText value="定制产品名称:" />
                        <p:inputText id="productName" value="#{item.productName}" label="定制产品名称" />
                        <h:outputText value="定制产品型号:" />
                        <p:inputText id="modelSpec" value="#{item.modelSpec}" label="定制产品型号" />

                        <h:outputText value="单位:" />
                        <p:selectOneMenu id="unit" value="#{item.unit.id_RE}" style="width:10em;" label="单位">
                            <f:selectItem itemLabel="--选择--" itemValue="" />
                            <f:selectItems value="#{thing.unitSelectItems}" />
                        </p:selectOneMenu>
                        <h:outputText value="对应物料:" />
                        <t:panelGrid columns="2">
                            <p:inputText id="decidedMaterial" readonly="true" value="#{item.decidedMaterial.label}" />
                            <p:commandButton id="chooseMaterial" value="..." onclick="chooseMaterialDialog.show()" />
                        </t:panelGrid>
                    </t:panelGrid>
                </p:tab>

                <p:tab title="附加属性">
                    <fr:listView id="attributesView" header="附加属性" style="panel" orientation="lr"
                        mbean="${bean.productAttributesMBean}" nested="true">
                        <f:facet name="columns">
                            <p:column headerText="属性名">
                                <h:outputText value="${entry.name}" />
                            </p:column>
                            <p:column headerText="属性值">
                                <h:outputText value="${entry.value}" />
                            </p:column>
                        </f:facet>
                        <h:panelGrid columns="2">
                            <h:outputText value="属性名称:" />
                            <p:inputText id="attributeName" value="#{item.name}" label="属性名称" />
                            <h:outputText value="属性值:" />
                            <p:inputText id="attributeValue" value="#{item.value}" label="属性值" />
                        </h:panelGrid>
                    </fr:listView>
                </p:tab>

                <p:tab title="报价">
                    <fr:listView id="quotationsIndexView" editView=":quotationsEditView" header="报价" style="indexPanel"
                        orientation="td" mbean="${bean.productQuotationsMBean}" nested="true" readonly="#{not bean.editing}">
                        <f:facet name="columns">
                            <p:column headerText="价格">
                                <h:outputText value="${entry.price}" />
                            </p:column>
                            <p:column headerText="数量" styleClass="f-right">
                                <h:outputText value="${entry.quantity}" />
                            </p:column>
                            <p:column headerText="折扣" styleClass="f-right">
                                <h:outputText value="${entry.discountPercent}%" />
                            </p:column>
                            <p:column headerText="报价日期">
                                <h:outputText value="${entry.createdDate}">
                                    <f:convertDateTime pattern="yy-MM-dd" timeZone="Asia/Shanghai" />
                                </h:outputText>
                            </p:column>
                        </f:facet>
                    </fr:listView>
                </p:tab>
            </p:tabView>
        </fr:listView>

        <fr:listView id="quotationsEditView" header="报价" style="editDialog" indexView=":pEditView:editForm:tv:quotationsIndexView"
            mbean="${bean.productQuotationsMBean}" readonly="#{not bean.editing}">
            <t:panelGrid columns="2" columnClasses="field-label, field-content">
                <h:outputLabel value="单价:" />
                <p:inputText value="#{item.price.value}" />
                <h:outputLabel value="币种：" />
                <p:selectOneMenu value="#{item.price.currencyCode}" style="width:20em;">
                    <f:selectItem itemValue="" itemLabel="--选择币种--" />
                    <f:selectItems value="#{monetary.currencySelectItems}" />
                </p:selectOneMenu>

                <h:outputText value="数量:" />
                <p:inputText id="quantity" value="#{item.quantity}" label="属性值" />

                <h:outputText value="折扣:" />
                <h:panelGroup>
                    <p:slider for="discount" display="discountText" style="width:200px" />
                    <h:inputHidden id="discount" value="#{item.discountPercent}" />
                    <h:outputText id="discountText" value="#{item.discountPercent}" />
                    <h:outputText value="%" />
                </h:panelGroup>

                <h:outputText value="备注:" />
                <p:inputText id="description" value="#{item.description}" label="备注" />
            </t:panelGrid>
        </fr:listView>


        <fr:listView id="partiesEditView" header="客户"
            style="editDialog"
            indexView=":editDialog:form:tv:partiesIndexView"
            mbean="${bean.partiesMBean}" readonly="#{not bean.editing}">
            <h:panelGrid columns="2">
                <h:outputLabel for="chooseCustomer" value="客户:" />
                <h:panelGroup>
                    <h:outputText id="party" value="${item.party.displayName}" />
                    <p:commandButton id="chooseCustomer" value="..." onclick="chooseCustomerDialog.show()" />
                </h:panelGroup>

                <h:outputText value="备注:" />
                <h:outputText value="${item.party.shortMemo}" />

                <h:outputLabel for="role" value="角色:" />
                <p:inputText id="role" label="角色" value="${item.role}" />
            </h:panelGrid>
        </fr:listView>

    </ui:define>
</ui:composition>
