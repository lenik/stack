<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:cc="http://java.sun.com/jsf/composite"
    xmlns:pc="http://bee32.com/plover/core" xmlns:pf="http://bee32.com/plover/faces" xmlns:p="http://primefaces.org/ui">

    <cc:interface>
        <cc:attribute name="style" default="panel" description="panel, dialog, indexPanel, editDialog" />
        <cc:attribute name="orientation" default="lr" description="lr=left-right, td=top-down" />
        <cc:attribute name="indexView" default=":${cc.clientId}" />
        <cc:attribute name="editView" default=":${cc.clientId}" />
        <cc:attribute name="nested" type="java.lang.Boolean" default="false" />
        <cc:attribute name="indexDialogVar" default="${pc:lastPart(cc.attrs.indexView, ':')}IndexDialog" />
        <cc:attribute name="editDialogVar" default="${pc:lastPart(cc.attrs.editView, ':')}EditDialog" />
        <cc:attribute name="header" required="true" />
        <cc:attribute name="legend" default="${cc.attrs.header}" />
        <cc:attribute name="mbean" type="java.lang.Object" required="true" />
        <cc:attribute name="smooth" type="java.lang.Boolean" default="false" />
        <cc:attribute name="copy" type="java.lang.Boolean" default="${cc.attrs.style != 'panel' or not cc.attrs.smooth}" />
        <cc:attribute name="paginator" type="java.lang.Boolean" default="true" />
        <cc:attribute name="creatable" type="java.lang.Boolean" default="true" />
        <cc:attribute name="editable" type="java.lang.Boolean" default="true" />
        <cc:attribute name="removable" type="java.lang.Boolean" default="true" />
        <cc:facet name="columns" required="true" />
        <cc:facet name="more" />
        <cc:facet name="indexButtons" />
        <cc:facet name="editButtons" />
    </cc:interface>

    <cc:implementation>
        <h:outputScript library="frame" name="ajax-validation.js" target="head" />

        <ui:decorate template="/template/listView-f4.xhtml">
            <ui:param name="style" value="${cc.attrs.style}" />
            <ui:param name="orientation" value="${cc.attrs.orientation}" />
            <ui:param name="nested" value="${cc.attrs.nested}" />
            <ui:param name="header" value="${cc.attrs.header}" />
            <ui:param name="legend" value="${cc.attrs.legend}" />
            <ui:param name="indexDialogVar" value="${cc.attrs.indexDialogVar}" />
            <ui:param name="editDialogVar" value="${cc.attrs.editDialogVar}" />
            <ui:param name="mbean" value="${cc.attrs.mbean}" />
            <ui:param name="smooth" value="${cc.attrs.smooth}" />

            <ui:define name="indexFormContent">
                <h:panelGrid columns="1">
                    <h:panelGroup id="dataContainer" layout="block">
                        <ui:insert name="dataContainer">
                            <p:dataTable id="dataTable" value="${mbean.selectableList}" selection="${mbean.selection}"
                                selectionMode="single" var="entry" paginator="${cc.attrs.paginator}" rows="10"
                                paginatorTemplate="${viewConfig.paginatorTemplate}" rowsPerPageTemplate="${viewConfig.pageSizeTemplate}"
                                resizableColumns="true" rowIndexVar="rowIndex">

                                <f:attribute name="smooth" value="${cc.attrs.smooth}" />

                                <!-- mbean not work, must be cc.attrs.mbean here. -->
                                <p:ajax event="rowSelect" listener="${cc.attrs.mbean.rowSelect}"
                                    update="${cc.attrs.indexView}:indexForm:ibuttons, ${cc.attrs.editView}:editForm:body, ${cc.attrs.editView}:more" />
                                <p:ajax event="rowUnselect" listener="${cc.attrs.mbean.rowUnselect}"
                                    update="${cc.attrs.indexView}:indexForm:ibuttons, ${cc.attrs.editView}:editForm:body, ${cc.attrs.editView}:more" />

                                <p:column id="rowIndexCol" headerText="序号">
                                    ${rowIndex + 1}
                                </p:column>

                                <cc:insertRawFacet name="columns" />

                            </p:dataTable>
                        </ui:insert>
                    </h:panelGroup>

                    <h:panelGroup id="ibuttons">
                        <table border="0" width="100%">
                            <tr>
                                <td align="left">
                                    <p:commandButton rendered="${cc.attrs.creatable}" id="create" value="添加"
                                        actionListener="${mbean.showCreateForm}"
                                        update=":@form, ${cc.attrs.editView}:editForm:body, ${cc.attrs.editView}:more"
                                        oncomplete="${style == 'panel' ? '' : cc.attrs.editDialogVar.concat('.show();')}" />
                                    <p:commandButton rendered="${cc.attrs.removable}" id="remove" value="移除"
                                        actionListener="${mbean.removeSelection}"
                                        update=":@form, ${cc.attrs.editView}:editForm:body, ${cc.attrs.editView}:more"
                                        disabled="${mbean.selection == null}" />
                                </td>
                                <td align="right">
                                    <cc:insertRawFacet name="indexButtons" />
                                    <p:commandButton id="edit" value="修改" disabled="${mbean.selection == null}"
                                        action="${mbean.showEditForm}" update="${cc.attrs.editView}:editForm:body, ${cc.attrs.editView}:more"
                                        oncomplete="${style == 'panel' ? '' : cc.attrs.editDialogVar.concat('.show();')}"
                                        rendered="${cc.attrs.editable and (style != 'panel' or not cc.attrs.smooth)}">
                                        <f:setPropertyActionListener target="${mbean.copyMode}"
                                            value="${cc.attrs.copy}" />
                                    </p:commandButton>
                                    <p:commandButton id="close" value="关闭"
                                        onclick="${cc.attrs.indexDialogVar}.hide()" rendered="${style == 'dialog'}" />
                                </td>
                            </tr>
                        </table>
                    </h:panelGroup>
                </h:panelGrid>
            </ui:define>

            <ui:define name="editFormContent">
                <ui:param name="item" value="${mbean.openedObject}" />
                <h:panelGroup id="noContent" layout="block"
                    rendered="${item == null and (style == 'dialog' or style == 'editDialog')}">
                    No opened object.
                </h:panelGroup>
                <h:panelGroup layout="block" rendered="${item != null}">
                    <cc:insertChildren />
                    <h:panelGroup id="ebuttons">
                        <table border="0" width="100%">
                            <tr>
                                <td align="left">
                                </td>
                                <td align="right">
                                    <cc:insertRawFacet name="editButtons" />
                                    <p:commandButton id="apply-validated"
                                        value="${(style == 'dialog' || style == 'editDialog') ? '确定' : (mbean.openedIndex == -1 ? '添加' : '应用').concat(smooth ? '*' : '')}"
                                        title="${(style == 'panel' || style == 'indexPanel') and smooth ? '在快速编辑模式下，当前修改的内容可能已经被自动保存。' : ''}"
                                        disabled="${mbean.openedObject == null}" action="${mbean.apply}"
                                        oncomplete="${style == 'panel' ? '' : cc.attrs.editDialogVar.concat('.hideValidated(args)')}"
                                        update="${cc.attrs.indexView}:indexForm:body, apply-validated">
                                        <f:setPropertyActionListener target="${mbean.copyMode}"
                                            value="${cc.attrs.copy}" />
                                    </p:commandButton>
                                    <p:commandButton id="cancel" value="取消" disabled="${mbean.openedObject == null}"
                                        actionListener="${mbean.cancel}" update="body, ${cc.attrs.editView}:more"
                                        rendered="${style == 'panel' and not smooth}" />
                                    <p:commandButton id="close" value="关闭" onclick="${cc.attrs.editDialogVar}.hide()"
                                        rendered="${style == 'dialog' or style == 'editDialog'}" />
                                </td>
                            </tr>
                        </table>
                    </h:panelGroup>
                </h:panelGroup>
            </ui:define>

            <ui:define name="editMore">
                <h:panelGroup id="more" layout="block">
                    <h:panelGroup id="moreContent" layout="block" rendered="${item != null}">
                        <cc:insertRawFacet name="more" />
                    </h:panelGroup>
                </h:panelGroup>
            </ui:define>

        </ui:decorate>
    </cc:implementation>

</html>