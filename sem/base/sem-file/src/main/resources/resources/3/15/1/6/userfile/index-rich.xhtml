<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions" xmlns:pc="http://bee32.com/plover/core"
    xmlns:sem="http://bee32.com/sem/functions" xmlns:p="http://primefaces.prime.com.tr/ui"
    xmlns:t="http://myfaces.apache.org/tomahawk">
<ui:composition template="/template/primefaces.xhtml">

    <ui:define name="title">userFileAdmin</ui:define>

    <ui:define name="content">

        <h:outputStylesheet>
            .ftd{vertical-align:top;}
            .std{vertical-align:top;}
            .class{float:right}
        </h:outputStylesheet>

        <h:form id="main">

            <t:panelGrid columns="2">
                <t:panelGroup>
                    <p:commandButton value="标签管理" onclick="tagAdminDialog.show();" />
                    <p:selectManyCheckbox id="tagIds"
                        value="#{userFileAdmin.selectedTags}"
                        layout="pageDirection">
                        <f:selectItems
                            value="#{userFileAdmin.userFileTags}" />
                        <f:selectItem itemLabel="附件" itemValue="-200" />
                        <p:ajax update="fileList"
                            listener="#{userFileAdmin.refreshList}" />
                    </p:selectManyCheckbox>
                </t:panelGroup>

                <t:panelGroup>
                    <t:panelGrid columns="4">
                        <h:outputText value="所有者" />
                        <p:selectOneMenu
                            value="#{userFileAdmin.selectedUserId}">
                            <f:selectItem itemLabel="(不限)" itemValue="0" />
                            <f:selectItems
                                value="#{userFileAdmin.usersWithFile}" />
                            <p:ajax update="fileList"
                                listener="#{userFileAdmin.refreshList}" />
                        </p:selectOneMenu>
                        <p:inputText
                            value="#{userFileAdmin.filePattern}" />
                        <p:commandButton value="查找"
                            actionListener="#{userFileAdmin.refreshList}"
                            update="fileList" />
                    </t:panelGrid>

                    <p:dataTable id="fileList"
                        value="#{userFileAdmin.userFiles}" var="item"
                        paginator="true"
                        paginatorTemplate="#{viewConfig.paginatorTemplate}"
                        rows="#{viewConfig.pageSize}"
                        rowsPerPageTemplate="#{viewConfig.pageSizeTemplate}"
                        lazy="true">
                        <p:column>
                            <a
                                href="#{location.WEB_APP}/3/15/1/6/file/view.do?id=#{item.id}">
                                <h:graphicImage
                                    value="/3/15/1/6/file/view.do?id=#{item.id}"
                                    width="36" height="36" /> </a>
                        </p:column>

                        <p:column headerText="附件名称">
                            <h:outputText value="#{item.name}" />
                        </p:column>

                        <p:column headerText="文件标题">
                            <h:outputText value="#{item.label}" />
                        </p:column>
                        <p:column headerText="附件标签">
                            <h:outputText value="#{item.formatTags}" />
                        </p:column>
                        <p:column headerText="所属人员">
                            <h:outputText
                                value="#{item.owner.displayName}" />
                        </p:column>

                        <p:column headerText="操作">
                            <p:commandLink title="编辑"
                                oncomplete="fileDialog.show();"
                                update="dialogForm:fileDialogPanel"
                                process="@this">
                                <f:setPropertyActionListener
                                    value="#{item}"
                                    target="#{userFileAdmin.activeFile}" />
                                <p:graphicImage
                                    value="#{location.ICON}/etool16/editor_area.gif" />
                            </p:commandLink>

                            <p:commandLink title="删除"
                                oncomplete="confirmation.show()"
                                process="@this">
                                <f:setPropertyActionListener
                                    value="#{item}"
                                    target="#{userFileAdmin.activeFile}" />
                                <p:graphicImage
                                    value="#{location.ICON}/etool16/delete_edit.gif" />
                            </p:commandLink>

                            <a
                                href="#{location.WEB_APP}/3/15/1/6/file/download.do?id=#{item.id}"
                                title="下载"> <p:graphicImage
                                    value="#{location.ICON}/etool16/group_by_file.gif" />
                            </a>

                        </p:column>
                    </p:dataTable>
                </t:panelGroup>
            </t:panelGrid>
        </h:form>

        <h:form id="updateForm">
            <t:panelGrid columns="1" columnClasses="ftd,std">
                    <p:fileUpload
                        fileUploadListener="#{userFileAdmin.handleFileUpload}"
                        mode="advanced" update=":main:fileList"
                        multiple="true"
                        allowTypes="${viewConfig.allowTypes}"
                        label="选择文件" />
            </t:panelGrid>
        </h:form>

        <h:form id="dialogForm">
            <p:confirmDialog message="您确定要删除此附件吗?" showEffect="bounce" hideEffect="explode" header="注意" severity="alert"
                widgetVar="confirmation">

                <p:commandButton value="删除" actionListener="#{userFileAdmin.removeFile}"
                    oncomplete="confirmation.hide();" update="main:fileList" />
                <p:commandButton value="取消" onclick="confirmation.hide();" />

            </p:confirmDialog>

            <p:confirmDialog message="确定要删除此标签吗?" header="提示" severity="alert" widgetVar="deleteTagConfirmation"
                modal="true">

                <p:commandButton value="删除" actionListener="#{userFileAdmin.deleteTag}"
                    oncomplete="deleteTagConfirmation.hide();" update="dialogForm:tagAdmin,main:tagIds" />
                <p:commandButton value="取消" onclick="deleteTagConfirmation.hide()" />
            </p:confirmDialog>

            <p:dialog widgetVar="tagAdminDialog" height="400" width="600" header="标签管理" modal="true">
                <t:panelGrid columns="2" columnClasses="ftd,std" style="width:100%;" id="tagAdmin">
                    <p:selectOneListbox value="#{userFileAdmin.activeTag.id}">
                        <f:selectItems value="#{userFileAdmin.userFileTags}" />
                    </p:selectOneListbox>
                    <t:panelGroup>
                        <p:commandButton value="新标签" actionListener="#{userFileAdmin.createNewTag}"
                            oncomplete="newTagDialog.show();" update="dialogForm:newTag,main:tagIds" />
                        <br />
                        <p:commandButton value="删除标签" onclick="deleteTagConfirmation.show();" />
                        <br />

                    </t:panelGroup>
                </t:panelGrid>
            </p:dialog>

            <p:dialog widgetVar="newTagDialog" height="300" width="400" header="新建标签">
                <t:panelGrid columns="2" id="newTag">
                    <h:outputText value="标签名称:" />
                    <p:inputText value="#{userFileAdmin.newTag.name}" />
                </t:panelGrid>
                <p:commandButton value="保存" actionListener="#{userFileAdmin.saveOrUpdateTag}"
                    oncomplete="newTagDialog.hide()" update="dialogForm:tagAdmin,main:tagIds" />
                <p:commandButton value="取消" onclick="newTagDialog.hide();" />
            </p:dialog>

            <p:dialog widgetVar="selectTagsDialog" width="300" height="400" header="选择标签" modal="true">
                <p:selectManyMenu value="#{userFileAdmin.selectedTagsToAdd}" style="width:100px;height:300px;">
                    <f:selectItems value="#{userFileAdmin.userFileTags}" />
                </p:selectManyMenu>
                <p:commandButton value="确定" actionListener="#{userFileAdmin.doSelectTags}"
                    oncomplete="selectTagsDialog.hide();" update="dialogForm:fileDialogPanel" />
                <p:commandButton value="取消" onclick="selectTagsDialog.hide();" />
            </p:dialog>

            <p:dialog id="fileDialog" widgetVar="fileDialog" width="600" height="650" header="编辑附件">
                <h:panelGroup id="fileDialogPanel">
                    <t:panelGrid columns="2">

                        <t:panelGroup colspan="2">
                            <div align="center">
                                <img width="480" src="#{userFileAdmin.activeFile.imageHref}" border="1" />
                            </div>
                        </t:panelGroup>

                        <h:outputText value="文件名:" />
                        <t:panelGroup>
                            <p:inputText value="#{userFileAdmin.activeFile.prefixName}" style="width:270px;" />
                            <h:outputText value="#{userFileAdmin.activeFile.extensionName}" />
                        </t:panelGroup>

                        <h:outputText value="文件标题:" />
                        <p:inputText value="#{userFileAdmin.activeFile.label}" style="width:270px;" />

                        <h:outputText value="文件描述:" />
                        <p:inputTextarea value="#{userFileAdmin.activeFile.description}"
                            style="width:270px;height:50px;" />

                        <h:outputText value="选择标签:" />
                        <t:panelGrid columns="2">
                            <p:selectOneListbox value="#{userFileAdmin.activeTagId}" style="width:100px;height:100px;">
                                <f:selectItems value="#{userFileAdmin.activeFile.tagItems}" />
                            </p:selectOneListbox>

                            <t:panelGroup>
                                <p:commandButton value="选择标签" onclick="selectTagsDialog.show();" />
                                <p:commandButton value="删除标签" actionListener="#{userFileAdmin.removeActiveTag}"
                                    update="dialogForm:fileDialogPanel" />
                            </t:panelGroup>
                        </t:panelGrid>

                        <p:commandButton value="确定"
                            actionListener="#{userFileAdmin.editUserFile}"
                            oncomplete="fileDialog.hide();"
                            update="main:fileList" />
                        <p:commandButton value="取消"
                            onclick="fileDialog.hide();" />

                    </t:panelGrid>
                </h:panelGroup>
            </p:dialog>
        </h:form>

    </ui:define>
</ui:composition>
</html>
