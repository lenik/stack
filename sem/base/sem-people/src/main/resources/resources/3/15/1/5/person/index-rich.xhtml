<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core" xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
    xmlns:p="http://primefaces.org/ui" xmlns:icsf="http://java.sun.com/jsf/composite/3/7" xmlns:sem="http://java.sun.com/jsf/composite/3/15"
    xmlns:t="http://myfaces.apache.org/tomahawk"
    template="/template/simple-entity.xhtml">

    <ui:param name="title" value="联系人管理" />
    <ui:param name="bean" value="#{personAdminBean}" />

    <ui:define name="dataColumns">
        <p:column headerText="姓名">
            <h:outputText value="#{entry.displayName}" />
        </p:column>

        <p:column headerText="性别">
            <h:outputText value="#{entry.sexText}" />
        </p:column>

        <p:column headerText="联系电话">
            <h:outputText value="#{entry.contactsString}" />
        </p:column>

        <p:column headerText="生日">
            <h:outputText value="#{entry.birthday}">
                <f:convertDateTime pattern="yyyy-MM-dd" timeZone="Asia/Shanghai" />
            </h:outputText>
        </p:column>

        <p:column headerText="证件类型">
            <h:outputText value="#{entry.sidType.label}" />
        </p:column>

        <p:column headerText="证件号码">
            <h:outputText value="#{entry.sid}" />
        </p:column>

        <p:column headerText="户籍">
            <h:outputText value="#{entry.censusRegister}" />
        </p:column>
    </ui:define>

    <ui:define name="editDialog">
        <p:dialog header="联系人资料" widgetVar="editDialog" modal="true">
            <h:form id="form" style="max-height: 40em; margin: 1em">
                <c:set var="obj" value="#{bean.activeObject}" />
                <p:tabView id="tv" rendered="${obj!=null}" style="width:100%;">
                    <p:tab id="tab1" title="详细信息">
                        <h:inputHidden id="personId" value="#{obj.id}" />

                        <h:panelGrid columns="4"
                            columnClasses="detail_col_title,detail_col_value,detail_col_title,detail_col_value">

                            <h:outputLabel for="personTags" value="标签" />
                            <h:panelGroup colspan="3">
                                <h:panelGrid columns="2">
                                    <p:selectOneListbox id="personTags" value="#{personAdminBean.selectedTagId}"
                                        style="height:80px; width:200px;">
                                        <f:selectItems value="#{obj.tags}" var="tag" itemLabel="#{tag.label}"
                                            itemValue="#{tag.id}" />
                                    </p:selectOneListbox>
                                    <h:panelGrid colums="2">
                                        <p:commandButton value="增加标签" disabled="#{obj == null}" onclick="tagDlg.show();" />
                                        <p:commandButton value="删除标签" disabled="#{obj == null}"
                                            actionListener="#{personAdminBean.deleteTag}" update="personTags" />
                                    </h:panelGrid>
                                </h:panelGrid>
                            </h:panelGroup>

                            <h:outputLabel for="personName" value="姓名" />
                            <p:inputText id="personName" value="#{obj.name}" />
                            <h:outputLabel for="personFullName" value="全名" />
                            <p:inputText id="personFullName" value="#{obj.fullName}" />

                            <h:outputLabel for="personBirthday" value="生日" />
                            <t:panelGroup colspan="3">
                                <p:calendar id="personBirthday"
                                    navigator="true" locale="zh_CN"
                                    pattern="yyyy-MM-dd"
                                    value="#{obj.birthday}"
                                    showOn="button" />
                            </t:panelGroup>

                            <h:outputLabel for="personSidType" value="证件类型" />
                            <p:selectOneMenu id="personSidType" value="#{obj.sidType.id}" style="width:150px;">
                                <f:selectItem itemValue="" itemLabel="--选择证件类型--" />
                                <f:selectItems value="#{personAdminBean.sidTypes}" />
                            </p:selectOneMenu>
                            <h:outputLabel for="personSid" value="证件号码" />
                            <p:inputText id="personSid" value="#{obj.sid}" />

                            <h:outputLabel for="personSex" value="性别" />
                            <p:selectOneMenu id="personSex" value="#{obj.sex}" style="width:150px;">
                                <f:selectItems value="#{personAdminBean.genders}" />
                            </p:selectOneMenu>
                            <h:outputLabel for="personCensusRegister" value="户籍" />
                            <p:inputText id="personCensusRegister" value="#{obj.censusRegister}" />

                            <h:outputLabel for="personInterests" value="兴趣爱好" />
                            <h:panelGroup colspan="3">
                                <p:inputText id="personInterests" value="#{obj.interests}" />
                            </h:panelGroup>

                            <h:outputLabel for="personMemo" value="备注" />
                            <h:panelGroup colspan="3">
                                <p:inputTextarea id="personMemo" value="#{obj.memo}" style="width:300px;height:100px;"
                                    effectDuration="400" />
                            </h:panelGroup>
                        </h:panelGrid>
                    </p:tab>

                    <p:tab id="tab2" title="联系方式">
                        <p:toolbar id="contactToolbar">
                            <p:toolbarGroup align="left">
                                <p:commandButton value="新增" disabled="#{obj == null or obj.id == null}"
                                    actionListener="#{personAdminBean.doNewContact}" update=":contactForm:contactHolder"
                                    async="true" onclick="contactHolderDlg.show();" />
                                <p:commandButton value="修改" actionListener="#{personAdminBean.doModifyContact}"
                                    disabled="#{not personAdminBean.contactSelected}" update=":contactForm:contactHolder"
                                    async="true" onclick="contactHolderDlg.show();" />
                                <p:commandButton value="删除" actionListener="#{personAdminBean.doDeleteContact}"
                                    disabled="#{not personAdminBean.contactSelected}" update=":editDialog:form:tv:contacts"
                                    async="true" />
                                <p:separator />
                            </p:toolbarGroup>
                        </p:toolbar>
                        <p:dataTable id="contacts" var="contact" value="#{personAdminBean.contacts}"
                            resizableColumns="true" selection="#{personAdminBean.selectedContact}" selectionMode="single"
                            rowKey="#{contact.id}" rowIndexVar="rowIndex">

                            <p:ajax event="rowSelect" listener="#{personAdminBean.onRowSelectContact}" update=":editDialog:form:tv:contactToolbar" />
                            <p:ajax event="rowUnselect" listener="#{personAdminBean.onRowUnselectContact}"
                                update=":editDialog:form:tv:contactToolbar" />

                            <p:column headerText="序号">
                                <h:outputText value="#{rowIndex + 1}" />
                            </p:column>

                            <p:column headerText="分类">
                                <h:outputText value="#{contact.category.label}" />
                            </p:column>

                            <p:column headerText="地址">
                                <h:outputText value="#{contact.address}" />
                            </p:column>
                            <p:column headerText="邮编">
                                <h:outputText value="#{contact.postCode}" />
                            </p:column>
                            <p:column headerText="电话">
                                <h:outputText value="#{contact.tel}" />
                            </p:column>
                            <p:column headerText="移动电话">
                                <h:outputText value="#{contact.mobile}" />
                            </p:column>
                            <p:column headerText="传真">
                                <h:outputText value="#{contact.fax}" />
                            </p:column>
                            <p:column headerText="email">
                                <h:outputText value="#{contact.email}" />
                            </p:column>
                            <p:column headerText="网址">
                                <h:outputText value="#{contact.website}" />
                            </p:column>
                            <p:column headerText="QQ">
                                <h:outputText value="#{contact.qq}" />
                            </p:column>
                        </p:dataTable>
                    </p:tab>

                    <p:tab id="tab3" title="相关客户/供应商">
                        <p:dataTable id="roles" var="role" value="#{personAdminBean.roles}"
                            resizableColumns="true" selection="#{personAdminBean.selectedRole}" selectionMode="single"
                            rowKey="#{role.id}" rowIndexVar="rowIndex">

                            <p:column headerText="序号">
                                <h:outputText value="#{rowIndex + 1}" />
                            </p:column>

                            <p:column headerText="所在部门">
                                <h:outputText value="#{role.orgUnit.name}" />
                            </p:column>

                            <p:column headerText="职务">
                                <h:outputText value="#{role.role}" />
                            </p:column>

                            <p:column headerText="负责业务">
                                <h:outputText value="#{role.roleDetail}" />
                            </p:column>

                            <p:column headerText="客户/供应商名称">
                                <h:outputText value="#{role.org.name}" />
                            </p:column>

                            <p:column headerText="成立日期">
                                <h:outputText value="#{role.org.birthday}">
                                    <f:convertDateTime pattern="yyyy-MM-dd" timeZone="Asia/Shanghai" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="公司类型">
                                <h:outputText value="#{role.org.type.label}" />
                            </p:column>

                            <p:column headerText="税务登记号">
                                <h:outputText value="#{role.org.sid}" />
                            </p:column>

                            <p:column headerText="公司规模">
                                <h:outputText value="#{role.org.size}" />
                            </p:column>

                        </p:dataTable>
                    </p:tab>
                </p:tabView>

                <div align="right">
                    <p:commandButton id="save-validated" value="保存" actionListener="#{bean.save}"
                        update=":mainForm:dataTable" oncomplete="editDialog.hideValidated(args)" />
                    <p:commandButton value="取消" onclick="editDialog.hide()" />
                </div>
            </h:form>
        </p:dialog>
    </ui:define>

    <ui:define name="dialogs">
        <p:dialog header="标签添加" widgetVar="tagDlg" modal="true" height="500" width="640">
            <h:form id="tagForm">
                <h:panelGroup id="tagHolder">
                    <p:selectManyMenu value="#{personAdminBean.selectedTagsToAdd}" style="height:300px">
                        <f:selectItems value="#{personAdminBean.tags}" />
                    </p:selectManyMenu>
                </h:panelGroup>
                <h:panelGrid columns="2">
                    <p:commandButton value="添加" actionListener="#{personAdminBean.addTags}" oncomplete="tagDlg.hide();"
                        async="true" update=":editDialog:form:tv:personTags" />
                    <p:commandButton value="取消" oncomplete="tagDlg.hide();" />
                </h:panelGrid>
            </h:form>
        </p:dialog>

        <p:dialog header="联系方式编辑" widgetVar="contactHolderDlg" modal="true" height="500" width="640">
            <h:form id="contactForm">
                <h:panelGroup id="contactHolder">
                    <h:inputHidden id="contactId" value="#{personAdminBean.contact.id}" />
                    <h:panelGrid columns="4"
                        columnClasses="detail_col_title,detail_col_value,detail_col_title,detail_col_value">

                        <h:outputLabel for="contactCategory" value="分类" />
                        <h:panelGroup colspan="3">
                            <p:selectOneMenu id="contactCategory" value="#{personAdminBean.contact.category.id}"
                                style="width:200px;">
                                <f:selectItem itemValue="" itemLabel="--选择联系方式分类--" />
                                <f:selectItems value="#{personAdminBean.contactCategories}" />
                            </p:selectOneMenu>
                        </h:panelGroup>

                        <h:outputLabel for="contactAddress" value="地址" />
                        <p:inputText id="contactAddress" value="#{personAdminBean.contact.address}" />
                        <h:outputLabel for="contactPostCode" value="邮编" />
                        <p:inputText id="contactPostCode" value="#{personAdminBean.contact.postCode}" />

                        <h:outputLabel for="contactTel" value="电话" />
                        <p:inputText id="contactTel" value="#{personAdminBean.contact.tel}" />
                        <h:outputLabel for="contactMobile" value="移动电话" />
                        <p:inputText id="contactMobile" value="#{personAdminBean.contact.mobile}" />

                        <h:outputLabel for="contactFax" value="传真" />
                        <p:inputText id="contactFax" value="#{personAdminBean.contact.fax}" />
                        <h:outputLabel for="contactEmail" value="email" />
                        <p:inputText id="contactEmail" value="#{personAdminBean.contact.email}" />

                        <h:outputLabel for="contactWebsite" value="网址" />
                        <p:inputText id="contactWebsite" value="#{personAdminBean.contact.website}" />
                        <h:outputLabel for="contactQq" value="qq" />
                        <p:inputText id="contactQq" value="#{personAdminBean.contact.qq}" />

                        <h:panelGroup />
                        <h:panelGroup colspan="2">
                            <h:panelGrid columns="2">
                                <p:commandButton value="保存" actionListener="#{personAdminBean.doSaveContact}"
                                    oncomplete="contactHolderDlg.hide();" async="true" update=":editDialog:form:tv:contacts" />
                                <p:commandButton value="取消" oncomplete="contactHolderDlg.hide();" />
                            </h:panelGrid>
                        </h:panelGroup>
                        <h:panelGroup />

                    </h:panelGrid>
                </h:panelGroup>
            </h:form>
        </p:dialog>

    </ui:define>
</ui:composition>
