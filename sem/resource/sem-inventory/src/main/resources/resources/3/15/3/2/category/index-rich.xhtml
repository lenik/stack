<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:h="http://java.sun.com/jsf/html" xmlns:f="http://java.sun.com/jsf/core"
    xmlns:c="http://java.sun.com/jsp/jstl/core" xmlns:fmt="http://java.sun.com/jsp/jstl/fmt"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions" xmlns:pc="http://bee32.com/plover/core"
    xmlns:sem="http://bee32.com/sem/functions" xmlns:p="http://primefaces.org/ui"
    xmlns:t="http://myfaces.apache.org/tomahawk">
<!-- InstanceBegin template="/Templates/seccaJsf.dwt.jsp" codeOutsideHTMLIsLocked="false" -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
</head>

<ui:composition template="/template/primefaces.xhtml">

    <ui:define name="title">物料分类管理</ui:define>

    <ui:define name="content">

        <style type="text/css">
                .column1{
                    vertical-align:top;
                    width:35%;
                }
                .column2{
                    vertical-align:top;
                    width:65%;
                }
        </style>

        <h:form id="mainForm">
            <p:tabView id="mainTab">
                <p:tab title="物料分类设置">

                    <p:toolbar id="categoryToolbar">
                        <p:toolbarGroup>
                            <p:commandButton value="新增" title="新增分类"
                                actionListener="#{materialSettingsBean.createCategoryForm}"
                                oncomplete="categoryWizardDialog.show();" update=":dialogForm:categoryForm" />
                            <p:commandButton id="newSubCategory" value="新增子分类" title="新增子分类"
                                actionListener="#{materialSettingsBean.addSubCategory}"
                                update=":dialogForm:categoryForm" oncomplete="categoryWizardDialog.show();"
                                disabled="#{materialSettingsBean.materialCategoryMainTree.selectedNode == null}" />
                            <p:commandButton id="editCategory" value="编辑" title="编辑分类"
                                actionListener="#{materialSettingsBean.editCategoryForm}"
                                update=":dialogForm:categoryForm" oncomplete="categoryWizardDialog.show();"
                                disabled="#{materialSettingsBean.materialCategoryMainTree.selectedNode == null}" />
                            <p:commandButton id="deleteCategory" value="删除" title="删除分类"
                                actionListener="#{materialSettingsBean.destroyCategory}" update=":mainForm:mainTab"
                                disabled="#{materialSettingsBean.materialCategoryMainTree.selectedNode == null}" />
                        </p:toolbarGroup>
                    </p:toolbar>

                    <p:panel>
                        <p:treeTable id="mainTree"
                            value="#{materialSettingsBean.materialCategoryMainTree.rootNode}"
                            var="node" dynamic="true" selectionMode="single"
                            selection="#{materialSettingsBean.materialCategoryMainTree.selectedNode}"
                            scrollable="true"
                            scrollHeight="380" scrollWidth="400">

                            <p:ajax event="select" update=":mainForm:mainTab:categoryToolbar" />
                            <p:ajax event="unselect" update=":mainForm:mainTab:categoryToolbar" />

                            <p:column>
                                <f:facet name="header">分类名称</f:facet>
                                <h:outputText value="#{node.name}" />
                            </p:column>
                        </p:treeTable>


                    </p:panel>

                </p:tab>

                <p:tab title="物料单位设置">

                    <p:toolbar>
                        <p:toolbarGroup>
                            <p:commandButton value="新增" title="新增单位"
                                actionListener="#{materialSettingsBean.createUnitForm}" oncomplete="unitDialog.show();"
                                update=":dialogForm:unitForm" />
                        </p:toolbarGroup>
                    </p:toolbar>

                    <p:panel>
                        <h:outputText value="单位:" />
                        <p:dataTable var="unit" value="#{materialSettingsBean.unitList}" id="unitList">
                            <p:column headerText="单位名称">
                                <h:outputText value="#{unit.label}" />
                            </p:column>
                            <p:column headerText="单位代码">
                                <h:outputText value="#{unit.name}" />
                            </p:column>
                            <p:column headerText="标准单位">
                                <h:outputText value="#{unit.stdUnit.displayId}" />
                            </p:column>
                            <p:column headerText="倍率">
                                <h:outputText value="#{unit.scale}" />
                            </p:column>
                            <p:column headerText="操作">
                                <p:commandLink title="编辑" oncomplete="unitDialog.show();" update=":dialogForm:unitForm"
                                    actionListener="#{materialSettingsBean.setDictNameCantEdit}">
                                    <p:graphicImage value="#{location.ICON}/etool16/editor_area.gif" />
                                    <f:setPropertyActionListener value="#{unit}"
                                        target="#{materialSettingsBean.selectedUnit}" />
                                </p:commandLink>
                                <p:commandLink title="删除" onclick="unitConfirmation.show();">
                                    <p:graphicImage value="#{location.ICON}/etool16/delete_edit.gif" />
                                    <f:setPropertyActionListener value="#{unit}"
                                        target="#{materialSettingsBean.selectedUnit}" />
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                    </p:panel>

                </p:tab>

                <p:tab title="单位换算表设置">

                    <p:toolbar>
                        <p:toolbarGroup>
                            <p:commandButton value="新增" title="新增单位换算表"
                                actionListener="#{materialSettingsBean.createUnitConvForm}"
                                oncomplete="unitConvDialog.show();" update=":dialogForm:unitConvForm" />
                        </p:toolbarGroup>
                    </p:toolbar>

                    <p:panel>
                        <h:outputText value="单位换算表:" />
                        <p:dataTable id="unitConvList" var="unitConv" value="#{materialSettingsBean.unitConvList}">
                            <p:column headerText="源单位">
                                <h:outputText value="#{unitConv.unit.name}" />
                            </p:column>
                            <p:column headerText="操作">
                                <p:commandLink title="详细" actionListener="#{materialSettingsBean.setUnitConvUneditable}"
                                    update=":dialogForm:unitConvForm" oncomplete="unitConvDialog.show();">
                                    <f:setPropertyActionListener value="#{unitConv}"
                                        target="#{materialSettingsBean.activeUnitConv}" />
                                    <p:graphicImage value="#{location.ICON}/etool16/validate.gif" />
                                </p:commandLink>
                                <p:commandLink title="编辑" oncomplete="unitConvDialog.show();"
                                    actionListener="#{materialSettingsBean.setDictNameCantEdit}"
                                    update=":dialogForm:unitConvForm">
                                    <p:graphicImage value="#{location.ICON}/etool16/editor_area.gif" />
                                    <f:setPropertyActionListener value="#{unitConv}"
                                        target="#{materialSettingsBean.selectedUnitConv}" />
                                </p:commandLink>
                                <p:commandLink title="删除" oncomplete="unitConvConfirmation.show();">
                                    <p:graphicImage value="#{location.ICON}/etool16/delete_edit.gif" />
                                    <f:setPropertyActionListener value="#{unitConv}"
                                        target="#{materialSettingsBean.selectedUnitConv}" />
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>
                    </p:panel>

                </p:tab>

                <p:tab title="基础价格设置">

                    <t:panelGrid columns="2" columnClasses="column1,column2">

                        <p:treeTable id="selectCategoryTree"
                            value="#{materialSettingsBean.materialPriceTree.rootNode}"
                            var="node" dynamic="true" selectionMode="single"
                            selection="#{materialSettingsBean.materialPriceTree.selectedNode}"
                            scrollable="true" scrollHeight="480"
                            scrollWidth="250">

                            <p:ajax event="select" listener="#{materialSettingsBean.materialPriceTree.onNodeSelect}"
                                update=":mainForm:mainTab:materialList" />

                            <p:column headerText="分类名称" style="width:220px">
                                <h:outputText value="#{node.name}" />
                            </p:column>
                        </p:treeTable>

                        <p:dataTable id="materialList" value="#{materialSettingsBean.materialList}" var="item">
                            <p:column headerText="物料名称">
                                <h:outputText value="#{item.label}" />
                            </p:column>
                            <p:column headerText="规格型号">
                                <h:outputText value="#{item.modelSpec}" />
                            </p:column>
                            <p:column headerText="当前价格">
                                <h:outputText value="#{item.currentPrice}" />
                            </p:column>
                            <p:column headerText="操作">
                                <p:commandLink title="设置价格" oncomplete="priceDialog.show();"
                                    update=":dialogForm:historyPriceList,dialogForm:activePrice,dialogForm:temp">
                                    <p:graphicImage value="#{location.ICON}/etool16/editor_area.gif" />
                                    <f:setPropertyActionListener value="#{item}"
                                        target="#{materialSettingsBean.activeMaterial}" />
                                </p:commandLink>
                            </p:column>
                        </p:dataTable>

                    </t:panelGrid>
                </p:tab>

            </p:tabView>
        </h:form>

        <h:form id="dialogForm">

            <p:dialog header="提示" severity="alert" widgetVar="addPriceConfirm" modal="true">

                <t:panelGrid columns="2" id="tempConfirm">
                    <h:outputText value="确认价格:" />
                    <h:outputText value="#{materialSettingsBean.value}" />

                    <h:outputText value="确认货币代码:" />
                    <h:outputText value="#{materialSettingsBean.currencyCode}" />
                </t:panelGrid>
                <p:commandButton value="确定" actionListener="#{materialSettingsBean.doAddMCValue}"
                    update=":dialogForm:historyPriceList" oncomplete="addPriceConfirm.hide();" />
                <p:commandButton value="取消" onclick="addPriceConfirm.hide();" />

            </p:dialog>

            <p:dialog header="materialPrice" widgetVar="priceDialog" height="400" width="600">
                <t:panelGrid columns="2" id="activePrice">
                    <h:outputText value="物料名称:" />
                    <h:outputText
                        value="#{materialSettingsBean.activeMaterial.label}" />
                    <h:outputText value="批号:" />
                    <h:outputText
                        value="#{materialSettingsBean.activeMaterial.serial}" />
                </t:panelGrid>

                <p:separator />

                <t:panelGrid columns="4" id="temp">
                    <h:outputText value="设置价格:" />
                    <p:inputText value="#{materialSettingsBean.value}" />

                    <h:outputText value="币种:" />
                    <p:selectOneMenu
                        value="#{materialSettingsBean.currencyCode}"
                        style="width:170px;">
                        <f:selectItems
                            value="#{materialSettingsBean.currencies}" />
                    </p:selectOneMenu>

                </t:panelGrid>
                <p:commandButton value="添加"
                    oncomplete="addPriceConfirm.show();"
                    update=":dialogForm:tempConfirm" />

                <p:separator />

                <h:outputText value="历史价格列表:" />
                <p:dataTable id="historyPriceList"
                    value="#{materialSettingsBean.activeMaterial.prices}"
                    var="item">
                    <p:column headerText="日期">
                        <h:outputText value="#{item.date}" />
                    </p:column>
                    <p:column headerText="价格">
                        <h:outputText value="#{item.price}" />
                    </p:column>
                    <p:column headerText="货币代码">
                        <h:outputText value="#{item.price.currencyCode}" />
                    </p:column>
                </p:dataTable>

                <p:commandButton value="确定" actionListener="#{materialSettingsBean.updatePrice}"
                    oncomplete="priceDialog.hide();" update=":mainForm:mainTab:materialList" />
                <p:commandButton value="取消" onclick="priceDialog.hide();" />
            </p:dialog>


            <p:confirmDialog message="确定要删除此单位吗?" showEffect="bounce" hideEffect="explode" header="提示" severity="alert"
                widgetVar="unitConfirmation">

                <p:commandButton value="确定" update=":mainForm:mainTab:unitList" oncomplete="unitConfirmation.hide()"
                    actionListener="#{materialSettingsBean.destroyUnit}" />
                <p:commandButton value="取消" onclick="unitConfirmation.hide()" type="button" />

            </p:confirmDialog>

            <p:confirmDialog message="确定要删除此单位换算表吗?" showEffect="bounce" hideEffect="explode" header="提示"
                severity="alert" widgetVar="unitConvConfirmation">

                <p:commandButton value="确定" update=":mainForm:mainTab:unitConvList"
                    oncomplete="unitConvConfirmation.hide()" actionListener="#{materialSettingsBean.destroyUnitConv}" />
                <p:commandButton value="取消" onclick="unitConvConfirmation.hide()" type="button" />

            </p:confirmDialog>

            <p:dialog header="单位" widgetVar="unitDialog" height="300" width="450" modal="true">
                <p:panel id="unitForm">
                    <t:panelGrid columns="2">
                        <h:outputText value="单位名称:" />
                        <p:inputText value="#{materialSettingsBean.activeUnit.label}" />

                        <h:outputText value="单位代码:" />
                        <p:inputText value="#{materialSettingsBean.activeUnit.name}"
                            readonly="#{materialSettingsBean.cantEdit}" />

                        <h:outputText value="标准单位:" />
                        <p:selectOneMenu value="#{materialSettingsBean.activeUnit.stdUnit.displayId}"
                            style="width:100px;">
                            <f:selectItem itemLabel="" itemValue="" />
                            <f:selectItems value="#{materialSettingsBean.standardUnits}" />
                        </p:selectOneMenu>

                        <h:outputText value="倍率:" />
                        <p:inputText value="#{materialSettingsBean.activeUnit.scale}" />
                    </t:panelGrid>
                    <p:commandButton value="保存" actionListener="#{materialSettingsBean.doSaveUnit}"
                        oncomplete="unitDialog.hide();" update=":mainForm:mainTab:unitList" />
                    <p:commandButton value="取消" onclick="unitDialog.hide();" />
                </p:panel>
            </p:dialog>

            <p:dialog header="单位换算表" widgetVar="unitConvDialog" height="500" width="700" modal="true">
                <p:panel id="unitConvForm">
                    <t:panelGrid columns="2">
                        <h:outputText value="源单位:" />
                        <p:selectOneMenu value="#{materialSettingsBean.activeUnitConv.unit.displayId}"
                            style="width:100px;" disabled="#{materialSettingsBean.unitConvEditable}">
                            <f:selectItem itemLabel="--请选择--" itemValue="" />
                            <f:selectItems value="#{materialSettingsBean.units}" />
                        </p:selectOneMenu>
                    </t:panelGrid>
                    <hr/>
                    <h:outputText value="换算表:" />
                    <p:dataTable var="item" value="#{materialSettingsBean.activeUnitConv.itemList}" id="scaleList">
                        <p:column headerText="换算单位">
                            <h:outputText value="#{item.unit.label}" />
                        </p:column>
                        <p:column headerText="换算率">
                            <h:outputText value="#{item.scale}" />
                        </p:column>
                        <p:column headerText="操作" style="width:80px;">
                            <p:commandLink title="编辑" update=":dialogForm:scaleList" oncomplete="scaleDialog.show();"
                                disabled="#{materialSettingsBean.unitConvEditable}">
                                <p:graphicImage value="#{location.ICON}/etool16/editor_area.gif" />
                                <f:setPropertyActionListener value="#{item}"
                                    target="#{materialSettingsBean.selectedScale}" />
                            </p:commandLink>
                            <p:commandLink title="删除" update=":dialogForm:scaleList"
                                disabled="#{materialSettingsBean.unitConvEditable}">
                                <p:graphicImage value="#{location.ICON}/etool16/delete_edit.gif" />
                                <p:collector value="#{item}"
                                    removeFrom="#{materialSettingsBean.activeUnitConv.itemList}" />
                            </p:commandLink>
                        </p:column>
                    </p:dataTable>
                    <p:commandButton value="添加条目" actionListener="#{materialSettingsBean.createScaleItem}"
                        oncomplete="scaleDialog.show();" update="scaleForm"
                        disabled="#{materialSettingsBean.unitConvEditable}" />
                    <p:separator />
                    <p:commandButton value="保存" actionListener="#{materialSettingsBean.doSaveUnitConv}"
                        oncomplete="unitConvDialog.hide();" update=":mainForm:mainTab:unitConvList"
                        disabled="#{materialSettingsBean.unitConvEditable}" />
                    <p:commandButton value="取消" onclick="unitConvDialog.hide();" />
                </p:panel>
            </p:dialog>

            <p:dialog widgetVar="scaleDialog" height="300" width="400">
                <p:panel id="scaleForm">
                    <t:panelGrid columns="2">
                        <h:outputText value="换算单位" />
                        <p:selectOneMenu value="#{materialSettingsBean.activeScaleItem.unit.displayId}"
                            style="width:100px;">
                            <f:selectItem itemLabel="" itemValue="" />
                            <f:selectItems value="#{materialSettingsBean.units}" />
                        </p:selectOneMenu>

                        <h:outputText value="换算率" />
                        <p:inputText value="#{materialSettingsBean.activeScaleItem.scale}" />
                    </t:panelGrid>
                    <p:commandButton value="确定" actionListener="#{materialSettingsBean.doAddScaleItem}"
                        update=":dialogForm:scaleList" oncomplete="scaleDialog.hide();" />
                    <p:commandButton value="取消" onclick="scaleDialog.hide();" />
                </p:panel>
            </p:dialog>

            <p:dialog header="物料分类" widgetVar="categoryWizardDialog" height="250" width="450" modal="true">
                <p:panel id="categoryForm">
                    <t:panelGrid columns="2">
                        <h:outputText value="上级分类:" />
                        <t:panelGroup colspan="1">
                            <p:inputText value="#{materialSettingsBean.activeCategory.parent.name}" readonly="true" />
                            <p:commandButton value="..." title="选择上级分类"
                                actionListener="#{materialSettingsBean.refreshCategorySelectTree}"
                                oncomplete="categorySelectDialog.show();" update=":dialogForm:upperCategorySelect" />
                        </t:panelGroup>

                        <h:outputText value="分类名称:" />
                        <p:inputText value="#{materialSettingsBean.activeCategory.name}" />

                        <h:outputLabel for="classification" value="分类性质" />
                        <p:selectOneMenu id="classification"
                            value="#{materialSettingsBean.activeCategory.classification}" style="width:150px;">
                            <f:selectItems value="#{materialSettingsBean.classifications}" />
                        </p:selectOneMenu>

                        <p:commandButton id="saveCategory-validated" value="确认" actionListener="#{materialSettingsBean.doSaveCategory}"
                            update=":mainForm:mainTab:mainTree, :mainForm:mainTab:selectCategoryTree"
                            oncomplete="args.validationFailed || categoryWizardDialog.hide()" />
                        <p:commandButton value="取消" onclick="categoryWizardDialog.hide()" />
                    </t:panelGrid>
                </p:panel>

            </p:dialog>

            <p:dialog header="选择上级分类" widgetVar="categorySelectDialog" height="500" width="700" modal="true">

                <p:treeTable id="upperCategorySelect"
                    value="#{materialSettingsBean.materialCategorySelectTree.rootNode}"
                    var="node" dynamic="true" selectionMode="single"
                    selection="#{materialSettingsBean.materialCategorySelectTree.selectedNode}"
                    scrollable="true"
                    scrollHeight="380" scrollWidth="400">

                    <p:column>
                        <f:facet name="header">分类名称</f:facet>
                        <h:outputText value="#{node.name}" />
                    </p:column>
                </p:treeTable>
                <p:commandButton value="选择"
                    actionListener="#{materialSettingsBean.materialCategorySelectTree.onNodeSelect}"
                    update="categoryForm" oncomplete="categorySelectDialog.hide();" />
            </p:dialog>

        </h:form>

    </ui:define>
</ui:composition>
</html>
