<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper 
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bee32.zebra.oa.contact.impl.OrganizationMapper">

    <resultMap id="map1" type="com.bee32.zebra.oa.contact.Organization" extends="co.mapUS">
        <result property="birthday" column="birthday" />
        <result property="langTag" column="locale" />
        <result property="timeZoneId" column="timezone" />
        <result property="customer" column="customer" />
        <result property="supplier" column="supplier" />
        <result property="subject" column="subject" />
        <result property="comment" column="comment" />
        <result property="bank" column="bank" />
        <result property="account" column="bankacc" />

        <result property="size" column="size" />
        <result property="taxId" column="taxId" />

        <association property="contact" columnPrefix="c_" resultMap="Contact1" />
    </resultMap>

    <resultMap id="Contact1" type="com.bee32.zebra.oa.contact.Contact">
        <id property="id" column="_id" />
        <result property="rename" column="rename" />
        <result property="usage" column="usage" />
        <result property="regionId" column="region" />
        <result property="country" column="country" />
        <result property="r1" column="r1" />
        <result property="r2" column="r2" />
        <result property="r3" column="r3" />
        <result property="address1" column="address1" />
        <result property="address2" column="address2" />
        <result property="postalCode" column="postcode" />
        <result property="tel" column="tel" />
        <result property="mobile" column="mobile" />
        <result property="fax" column="fax" />
        <result property="email" column="email" />
        <result property="web" column="web" />
        <result property="qq" column="qq" />
    </resultMap>

    <sql id="select1"><![CDATA[
        select
            a.*,
            c._id "c__id",
            c.region "c_region",
            c.country "c_country",
            c.r1 "c_r1",
            c.r2 "c_r2",
            c.r3 "c_r3",
            c.address1 "c_address1",
            c.address2 "c_address2",
            c.postcode "c_postcode",
            c.tel "c_tel",
            c.mobile "c_mobile",
            c.fax "c_fax",
            c.email "c_email",
            c.web "c_web",
            c.qq "c_qq"
        from org a
            left join contact c on a.id=c.org and c.usage is null
        ]]>
    </sql>

    <select id="all" resultMap="map1">
        <include refid="select1" />
    </select>

    <select id="filter" resultMap="map1">
        <include refid="select1" />
        <where>
            <if test="type == 0">and not customer and not supplier and not shipper</if>
            <if test="shipper || type == 3">and shipper</if>
            <if test="type == 4">and false</if>

            <!-- co -->
            <if test="timeRange != null">and a.lastmod between #{timeRange.min, jdbcType=DATE} and #{timeRange.max, jdbcType=DATE}</if>
            
            <!-- party -->
            <if test="ageRange != null">and (now() - birthday) between interval '#{ageRange.min} years' and interval '#{ageRange.max} years'</if>
            <if test="customer || type == 1">and customer</if>
            <if test="supplier || type == 2">and supplier</if>
        </where>
    </select>

    <select id="select" parameterType="int" resultMap="map1">
        <include refid="select1" />
        <where>
            <if test="_parameter != null">a.id=#{id}</if>
        </where>
    </select>

    <select id="insert" resultType="long">
        <![CDATA[
        insert into org(code, label, description)
        values(#{codeName},#{label},#{description})
        returning id
    ]]></select>

    <update id="update">
        update org
        <set>
            <include refid="co.setU" />
        </set>
        where id=#{id}
    </update>

    <delete id="delete">
        delete from org where id=#{id}
    </delete>

    <select id="count" resultType="hashmap">
        select count(*) "total" from org
    </select>
    
</mapper>