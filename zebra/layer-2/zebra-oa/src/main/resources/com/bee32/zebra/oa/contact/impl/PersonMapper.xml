<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper 
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bee32.zebra.oa.contact.impl.PersonMapper">

    <resultMap id="map1" type="com.bee32.zebra.oa.contact.Person" extends="co.mapUS">
        <result property="birthday" column="birthday" />
        <result property="langTag" column="locale" />
        <result property="timeZoneId" column="timezone" />
        <result property="customer" column="customer" />
        <result property="supplier" column="supplier" />
        <result property="subject" column="subject" />
        <result property="comment" column="comment" />
        <result property="bank" column="bank" />
        <result property="account" column="bankacc" />

        <result property="gender" column="gender" />
        <result property="employee" column="employee" />
        <result property="homeland" column="homeland" />
        <result property="passport" column="passport" />
        <result property="socialSecurityNum" column="ssn" />
        <result property="driverLicenseNum" column="dln" />

        <association property="contact" columnPrefix="ct_" resultMap="com.bee32.zebra.oa.contact.impl.ContactMapper.map1" />
    </resultMap>

    <sql id="select1"><![CDATA[
        select
            a.*, c.*
        from person a
            left join avct_contact c on a.id=c.ct_person and c.ct_usage is null
    ]]></sql>

    <sql id="select2"><![CDATA[
        select
            a.*, c.*
        from person a
            left join avct_contact c on a.id=c.ct_person and c.ct_usage is null
    ]]></sql>

    <select id="all" resultMap="map1">
        <include refid="select1" />
    </select>

    <select id="filter" resultMap="map1">
        <include refid="select1" />
        <where>
            <if test="type == 0">and not customer and not supplier and not employee</if>
            <if test="employee || type == 4">and employee</if>
            <if test="type == 3">and false</if>
            <if test="surname != null">and substr(a.label,1,1)=#{surname}</if>

            <!-- co -->
            <if test="timeRange != null">and a.lastmod between #{timeRange.min, jdbcType=DATE} and #{timeRange.max, jdbcType=DATE}</if>
        
            <!-- party -->
            <if test="ageRange != null">and (now() - birthday) between interval '#{ageRange.min} years' and interval '#{ageRange.max} years'</if>
            <if test="customer || type == 1">and customer</if>
            <if test="supplier || type == 2">and supplier</if>
        </where>
    </select>

    <select id="select" parameterType="int" resultMap="map1">
        <include refid="select2" />
        <where>
            <if test="_parameter != null">a.id = #{id}</if>
        </where>
    </select>

    <select id="selectPrev" parameterType="int" resultMap="map1">
        <include refid="select2" />
        <where>
            <if test="_parameter != null">a.id &lt; #{id}</if>
        </where>
        order by id desc limit 1
    </select>
    
    <select id="selectNext" parameterType="int" resultMap="map1">
        <include refid="select2" />
        <where>
            <if test="_parameter != null">a.id &gt; #{id}</if>
        </where>
        order by id asc limit 1
    </select>
    
    <select id="insert" resultType="int"><![CDATA[
        insert into person(code, label, description)
            values(#{codeName},#{label},#{description})
            returning id
    ]]></select>

    <update id="update">
        update person
        <set>
            <include refid="co.setU" />
        </set>
        where id=#{id}
    </update>

    <delete id="delete">
        delete from person where id=#{id}
    </delete>

    <select id="count" resultType="hashmap">
        select count(*) "total" from person
    </select>

    <select id="histoBySurname" resultType="com.bee32.zebra.tk.util.F_WordCount"><![CDATA[
        select
            substr(label,1,1) "word",
            count(*) "count"
        from person
        group by substr(label,1,1)
        order by substr(label,1,1)
    ]]></select>

</mapper>